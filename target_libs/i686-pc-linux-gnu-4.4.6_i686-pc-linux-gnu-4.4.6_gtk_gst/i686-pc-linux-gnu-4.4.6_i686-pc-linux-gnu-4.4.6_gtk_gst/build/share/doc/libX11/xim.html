<!-- Creator     : groff version 1.20.1 -->
<!-- CreationDate: Wed Jan 25 10:49:51 2012 -->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta name="generator" content="groff -Thtml, see www.gnu.org">
<meta http-equiv="Content-Type" content="text/html; charset=US-ASCII">
<meta name="Content-Style" content="text/css">
<style type="text/css">
       p       { margin-top: 0; margin-bottom: 0; vertical-align: top }
       pre     { margin-top: 0; margin-bottom: 0; vertical-align: top }
       table   { margin-top: 0; margin-bottom: 0; vertical-align: top }
       h1      { text-align: center }
</style>
<title>The Input Method Protocol Version 1.0 X Consortium Standard X Version 11, Release 7 libX11 1.3.2</title>

</head>
<body>

<h1 align="center">The Input Method Protocol Version 1.0 X Consortium Standard X Version 11, Release 7 libX11 1.3.2</h1>

<a href="#1. Introduction1.1. ScopeThe internationalization in the X Window System Version 11,Release 5 (X11R5) provides a common API which applicationdevelopers can use to create portable internationalizedprograms and to adapt them to the requirements of differentnative languages, local customs, and character stringencodings (this is called &lsquo;&lsquo;localization&rsquo;&rsquo;). As one of itsinternationalization mechanisms X11R5 has defined afunctional interface for internationalized text input,called XIM (X Input Method).When a client-server model is used with an IM (Input Method)implementation, a protocol must be established between theclient and the server. However, the protocol used tointerface Input Method Servers (IM Servers) with the InputMethod libraries (IM libraries) to which applications arelinked was not addressed in X11R5. This led applicationdevelopers to depend on vendor-specific input methods,decreased the user&rsquo;s choice of available input methods, andmade it more difficult for developers to create portableapplications. This paper describes the Input Method Protocoldeveloped for X11R6 to resolve the above problems and toaddress the requirements of existing and future inputmethods.The Input Method Protocol is independent from the transportlayer used in communication between the IM library and theIM Server. Thus, the input method protocol can be built onany inter-process communication mechanism, such as TCP/IP orthe X protocol.In addition, the protocol provides for future extensionssuch as differing input model types.1.2. BackgroundText input is much more simple for some languages thanothers. English, for instance, uses an alphabet of amanageable size, and input consists of pressing thecorresponding key on a keyboard, perhaps in combination witha shift key for capital letters or special characters.Some languages have larger alphabets, or modifiers such asaccents, which require the addition of special keycombinations in order to enter text. These input methodsmay require &lsquo;&lsquo;dead-keys&rsquo;&rsquo; or &lsquo;&lsquo;compose-keys&rsquo;&rsquo; which, whenfollowed by different combinations of key strokes, generatedifferent characters.Text input for ideographic languages is much less simple.In these languages, characters represent actual objectsrather than phonetic sounds used in pronouncing a word, andthe number of characters in these languages may continue togrow. In Japanese, for instance, most text input methodsinvolve entering characters in a phonetic alphabet, afterwhich the input method searches a dictionary for possibleideographic equivalents (of which there may be many). Theinput method then presents the candidate characters for theuser to choose from.In Japanese, either Kana (phonetic symbols) or Roman lettersare typed and then a region is selected for conversion toKanji. Several Kanji characters may have the same phoneticrepresentation. If that is the case with the string entered,a menu of characters is presented and the user must choosethe appropriate one. If no choice is necessary or apreference has been established, the input method does thesubstitution directly.These complicated input methods must present stateinformation (Status Area), text entry and edit space(Preedit Area), and menu/choice presentations (AuxiliaryArea). Much of the protocol between the IM library and theIM Server involves managing these IM areas. Because of thesize and complexity of these input methods, and because ofhow widely they vary from one language or locale to another,they are usually implemented as separate processes which canserve many client processes on the same computer or network.1.3. Input Method StylesX11 internationalization support includes the following fourtypes of input method:- on-the-spot: The client application is directedby the IM Server to display allpre-edit data at the site of textinsertion. The client registerscallbacks invoked by the inputmethod during pre-editing.- off-the-spot: The client application providesdisplay windows for the pre-editdata to the input method whichdisplays into them directly.- over-the-spot: The input method displays pre-editdata in a window which it brings updirectly over the text insertionposition.- root-window: The input method displays allpre-edit data in a separate area ofthe screen in a window specific tothe input method.Client applications must choose from the available inputmethods supported by the IM Server and provide the displayareas and callbacks required by the input method.2. Architecture2.1. Implementation ModelWithin the X Window System environment, the following twotypical architectural models can be used as an inputmethod&rsquo;s implementation model.- Client/Server model:A separate process, the IM Server,processes input and handlespreediting, converting, andcommitting. The IM library withinthe application, acting as clientto the IM Server, simply receivesthe committed string from the IMServer.- Library model: All input is handled by the IMlibrary within the application.The event process is closed withinthe IM library and a separate IMServer process may not be required.Most languages which need complex preediting, such as Asianlanguages, are implemented using the Client/Server IM model.Other languages which need only dead key or compose keyprocessing, such as European languages, are implementedusing the Library model.In this paper, we discuss mainly the Client/Server IM modeland the protocol used in communication between the IMlibrary (client) and the IM Server.2.2. Structure of IMWhen the client connects or disconnects to the IM Server, anopen or close operation occurs between the client and the IMServer.The IM can be specified at the time of XOpenIM() by settingthe locale of the client and a locale modifier. Since the IMremembers the locale at the time of creation XOpenIM() canbe called multiple times (with the setting for the localeand the locale modifier changed) to support multiplelanguages.In addition, the supported IM type can be obtained usingXGetIMValues().The client usually holds multiple input (text) fields. Xlibprovides a value type called the &lsquo;&lsquo;Input Context&rsquo;&rsquo; (IC) tomanage each individual input field. An IC can be created byspecifying XIM using XCreateIC(), and it can be destroyedusing XDestroyIC().The IC can specify the type of IM which is supported by XIMfor each input field, so each input field can handle adifferent type of IM.Most importantly information such as the committed stringsent from the IM Server to the client, is exchanged based oneach IC.Since each IC corresponds to an input field, the focusedinput field should be announced to the IM Server usingXSetICFocus(). (XUnsetICFocus() can also be used to changethe focus.)2.3. Event Handling ModelExisting input methods support either the FrontEnd method,the BackEnd method, or both. This protocol specificallysupports the BackEnd method as the default method, but alsosupports the FrontEnd method as an optional IM Serverextension.The difference between the FrontEnd and BackEnd methods isin how events are delivered to the IM Server. (Fig. 1)2.3.1. BackEnd MethodIn the BackEnd method, client window input events are alwaysdelivered to the IM library, which then passes them to theIM Server. Events are handled serially in the orderdelivered, and therefore there is no synchronization problembetween the IM library and the IM Server.Using this method, the IM library forwards all KeyPress andKeyRelease events to the IM Server (as required by the EventFlow Control model described in section 2.4. &lsquo;&lsquo;Event FlowControl&rsquo;&rsquo;), and synchronizes with the IM Server (asdescribed in section 4.16. &lsquo;&lsquo;Filtering Events&rsquo;&rsquo;).2.3.2. FrontEnd MethodIn the FrontEnd method, client window input events aredelivered by the X server directly to both the IM Server andthe IM library. Therefore this method provides much betterinteractive performance while preediting (particularly incases such as when the IM Server is running locally on theuser&rsquo;s workstation and the client application is running onanother workstation over a relatively slow network).However, the FrontEnd model may have synchronizationproblems between the key events handled in the IM Server andother events handled in the client, and these problems couldpossibly cause the loss or duplication of key events. Forthis reason, the BackEnd method is the core methodsupported, and the FrontEnd method is made available as anextension for performance purposes. (Refer to Appendix A formore information.) 1">1. Introduction1.1. ScopeThe internationalization in the X Window System Version 11,Release 5 (X11R5) provides a common API which applicationdevelopers can use to create portable internationalizedprograms and to adapt them to the requirements of differentnative languages, local customs, and character stringencodings (this is called &lsquo;&lsquo;localization&rsquo;&rsquo;). As one of itsinternationalization mechanisms X11R5 has defined afunctional interface for internationalized text input,called XIM (X Input Method).When a client-server model is used with an IM (Input Method)implementation, a protocol must be established between theclient and the server. However, the protocol used tointerface Input Method Servers (IM Servers) with the InputMethod libraries (IM libraries) to which applications arelinked was not addressed in X11R5. This led applicationdevelopers to depend on vendor-specific input methods,decreased the user&rsquo;s choice of available input methods, andmade it more difficult for developers to create portableapplications. This paper describes the Input Method Protocoldeveloped for X11R6 to resolve the above problems and toaddress the requirements of existing and future inputmethods.The Input Method Protocol is independent from the transportlayer used in communication between the IM library and theIM Server. Thus, the input method protocol can be built onany inter-process communication mechanism, such as TCP/IP orthe X protocol.In addition, the protocol provides for future extensionssuch as differing input model types.1.2. BackgroundText input is much more simple for some languages thanothers. English, for instance, uses an alphabet of amanageable size, and input consists of pressing thecorresponding key on a keyboard, perhaps in combination witha shift key for capital letters or special characters.Some languages have larger alphabets, or modifiers such asaccents, which require the addition of special keycombinations in order to enter text. These input methodsmay require &lsquo;&lsquo;dead-keys&rsquo;&rsquo; or &lsquo;&lsquo;compose-keys&rsquo;&rsquo; which, whenfollowed by different combinations of key strokes, generatedifferent characters.Text input for ideographic languages is much less simple.In these languages, characters represent actual objectsrather than phonetic sounds used in pronouncing a word, andthe number of characters in these languages may continue togrow. In Japanese, for instance, most text input methodsinvolve entering characters in a phonetic alphabet, afterwhich the input method searches a dictionary for possibleideographic equivalents (of which there may be many). Theinput method then presents the candidate characters for theuser to choose from.In Japanese, either Kana (phonetic symbols) or Roman lettersare typed and then a region is selected for conversion toKanji. Several Kanji characters may have the same phoneticrepresentation. If that is the case with the string entered,a menu of characters is presented and the user must choosethe appropriate one. If no choice is necessary or apreference has been established, the input method does thesubstitution directly.These complicated input methods must present stateinformation (Status Area), text entry and edit space(Preedit Area), and menu/choice presentations (AuxiliaryArea). Much of the protocol between the IM library and theIM Server involves managing these IM areas. Because of thesize and complexity of these input methods, and because ofhow widely they vary from one language or locale to another,they are usually implemented as separate processes which canserve many client processes on the same computer or network.1.3. Input Method StylesX11 internationalization support includes the following fourtypes of input method:- on-the-spot: The client application is directedby the IM Server to display allpre-edit data at the site of textinsertion. The client registerscallbacks invoked by the inputmethod during pre-editing.- off-the-spot: The client application providesdisplay windows for the pre-editdata to the input method whichdisplays into them directly.- over-the-spot: The input method displays pre-editdata in a window which it brings updirectly over the text insertionposition.- root-window: The input method displays allpre-edit data in a separate area ofthe screen in a window specific tothe input method.Client applications must choose from the available inputmethods supported by the IM Server and provide the displayareas and callbacks required by the input method.2. Architecture2.1. Implementation ModelWithin the X Window System environment, the following twotypical architectural models can be used as an inputmethod&rsquo;s implementation model.- Client/Server model:A separate process, the IM Server,processes input and handlespreediting, converting, andcommitting. The IM library withinthe application, acting as clientto the IM Server, simply receivesthe committed string from the IMServer.- Library model: All input is handled by the IMlibrary within the application.The event process is closed withinthe IM library and a separate IMServer process may not be required.Most languages which need complex preediting, such as Asianlanguages, are implemented using the Client/Server IM model.Other languages which need only dead key or compose keyprocessing, such as European languages, are implementedusing the Library model.In this paper, we discuss mainly the Client/Server IM modeland the protocol used in communication between the IMlibrary (client) and the IM Server.2.2. Structure of IMWhen the client connects or disconnects to the IM Server, anopen or close operation occurs between the client and the IMServer.The IM can be specified at the time of XOpenIM() by settingthe locale of the client and a locale modifier. Since the IMremembers the locale at the time of creation XOpenIM() canbe called multiple times (with the setting for the localeand the locale modifier changed) to support multiplelanguages.In addition, the supported IM type can be obtained usingXGetIMValues().The client usually holds multiple input (text) fields. Xlibprovides a value type called the &lsquo;&lsquo;Input Context&rsquo;&rsquo; (IC) tomanage each individual input field. An IC can be created byspecifying XIM using XCreateIC(), and it can be destroyedusing XDestroyIC().The IC can specify the type of IM which is supported by XIMfor each input field, so each input field can handle adifferent type of IM.Most importantly information such as the committed stringsent from the IM Server to the client, is exchanged based oneach IC.Since each IC corresponds to an input field, the focusedinput field should be announced to the IM Server usingXSetICFocus(). (XUnsetICFocus() can also be used to changethe focus.)2.3. Event Handling ModelExisting input methods support either the FrontEnd method,the BackEnd method, or both. This protocol specificallysupports the BackEnd method as the default method, but alsosupports the FrontEnd method as an optional IM Serverextension.The difference between the FrontEnd and BackEnd methods isin how events are delivered to the IM Server. (Fig. 1)2.3.1. BackEnd MethodIn the BackEnd method, client window input events are alwaysdelivered to the IM library, which then passes them to theIM Server. Events are handled serially in the orderdelivered, and therefore there is no synchronization problembetween the IM library and the IM Server.Using this method, the IM library forwards all KeyPress andKeyRelease events to the IM Server (as required by the EventFlow Control model described in section 2.4. &lsquo;&lsquo;Event FlowControl&rsquo;&rsquo;), and synchronizes with the IM Server (asdescribed in section 4.16. &lsquo;&lsquo;Filtering Events&rsquo;&rsquo;).2.3.2. FrontEnd MethodIn the FrontEnd method, client window input events aredelivered by the X server directly to both the IM Server andthe IM library. Therefore this method provides much betterinteractive performance while preediting (particularly incases such as when the IM Server is running locally on theuser&rsquo;s workstation and the client application is running onanother workstation over a relatively slow network).However, the FrontEnd model may have synchronizationproblems between the key events handled in the IM Server andother events handled in the client, and these problems couldpossibly cause the loss or duplication of key events. Forthis reason, the BackEnd method is the core methodsupported, and the FrontEnd method is made available as anextension for performance purposes. (Refer to Appendix A formore information.) 1</a><br>
<a href="#2.4. Event Flow ControlThis protocol supports two event flow models forcommunication between the IM library and the IM Server(Static and Dynamic).Static Event Flow requires that input events always be sentto the IM Server from the client.Dynamic Event Flow, however, requires only that those inputevents which need to be processed (converted) be sent to theIM Server from the client.For instance, in the case of inputing a combination of ASCIIcharacters and Chinese characters, ASCII characters do notneed to be processed in the IM Server, so their key eventsdo not have to be sent to the IM Server. On the other hand,key events necessary for composing Chinese characters mustbe sent to the IM Server.Thus, by adopting the Dynamic Event Flow, the number ofrequests among the X Server, the client, and the IM Serveris significantly reduced, and the number of context switchesis also reduced, resulting in improved performance. The IMServer can send XIM_REGISTER_TRIGGERKEYS message in order toswitch the event flow in the Dynamic Event Flow.The protocol for this process is described in section 4.5.&lsquo;&lsquo;Event Flow Control&rsquo;&rsquo;.3. Default Preconnection ConventionIM Servers are strongly encouraged to register theirsymbolic names as the ATOM names into the IM Serverdirectory property, XIM_SERVERS, on the root window of thescreen_number 0. This property can contain a list of ATOMs,and the each ATOM represents each possible IM Server. IMServer names are restricted to POSIX Portable FilenameCharacter Set. To discover if the IM Server is active, seeif there is an owner for the selection with that atom name.To learn the address of that IM Server, convert theselection target TRANSPORT, which will return a string formof the transport address(es). To learn the supportedlocales of that IM Server, convert the selection targetLOCALES, which will return a set of names of the supportedlocales in the syntax X/Open defines.The basic semantics to determine the IM Server if there aremultiple ATOMs are found in XIM_SERVERS property, is firstfit if the IM Server name is not given as a X modifier&rsquo;scategory im.The address information retrievable from the TRANSPORTtarget is a transport-specific name. The preregisteredformats for transport-specific names are listed in AppendixB. Additional transport-specific names may be registeredwith X Consortium.For environments that lack X connections, or for IM Serverswhich do not use the X Window System, the preconnectionconvention with IM Server may be given outside the X Windowsystem (e.g. using a Name Service).4. ProtocolThe protocol described below uses the bi-directionalsynchronous/asynchronous request/reply/error model and isspecified using the same conventions outlined in Section 2of the core X Window System protocol [1]:4.1. Basic Requests Packet FormatThis section describes the requests that may be exchangedbetween the client and the IM Server.The basic request packet header format is as follows.major-opcode: CARD8minor-opcode: CARD8length: CARD16The MAJOR-OPCODE specifies which core request or extensionpackage this packet represents. If the MAJOR-OPCODEcorresponds to a core request, the MINOR-OPCODE contains 8bits of request-specific data. (If the MINOR-OPCODE is notused, it is 0.) Otherwise, the MAJOR-OPCODE and theMINOR-OPCODE are specified by XIM_QUERY_EXTENSION message.(Refer to 4.7. Query the supported extension protocol list.)The LENGTH field specifies the number of 4 bytes elementsfollowing the header. If no additional data is followed bythe header, the LENGTH field will be 0.4.2. Data TypesThe following data types are used in the core X IM Serverprotocol:BITMASK16CARD16BITMASK32CARD32PADDING FORMATWhere N is some expression, and Pad(N) is the number of bytes needed to round N up to amultiple of four.Pad(N) = (4 - (N mod 4)) mod 4LPCE1 A character from the4 X Portable Character Set in Latin PortableCharacter Encoding2">2.4. Event Flow ControlThis protocol supports two event flow models forcommunication between the IM library and the IM Server(Static and Dynamic).Static Event Flow requires that input events always be sentto the IM Server from the client.Dynamic Event Flow, however, requires only that those inputevents which need to be processed (converted) be sent to theIM Server from the client.For instance, in the case of inputing a combination of ASCIIcharacters and Chinese characters, ASCII characters do notneed to be processed in the IM Server, so their key eventsdo not have to be sent to the IM Server. On the other hand,key events necessary for composing Chinese characters mustbe sent to the IM Server.Thus, by adopting the Dynamic Event Flow, the number ofrequests among the X Server, the client, and the IM Serveris significantly reduced, and the number of context switchesis also reduced, resulting in improved performance. The IMServer can send XIM_REGISTER_TRIGGERKEYS message in order toswitch the event flow in the Dynamic Event Flow.The protocol for this process is described in section 4.5.&lsquo;&lsquo;Event Flow Control&rsquo;&rsquo;.3. Default Preconnection ConventionIM Servers are strongly encouraged to register theirsymbolic names as the ATOM names into the IM Serverdirectory property, XIM_SERVERS, on the root window of thescreen_number 0. This property can contain a list of ATOMs,and the each ATOM represents each possible IM Server. IMServer names are restricted to POSIX Portable FilenameCharacter Set. To discover if the IM Server is active, seeif there is an owner for the selection with that atom name.To learn the address of that IM Server, convert theselection target TRANSPORT, which will return a string formof the transport address(es). To learn the supportedlocales of that IM Server, convert the selection targetLOCALES, which will return a set of names of the supportedlocales in the syntax X/Open defines.The basic semantics to determine the IM Server if there aremultiple ATOMs are found in XIM_SERVERS property, is firstfit if the IM Server name is not given as a X modifier&rsquo;scategory im.The address information retrievable from the TRANSPORTtarget is a transport-specific name. The preregisteredformats for transport-specific names are listed in AppendixB. Additional transport-specific names may be registeredwith X Consortium.For environments that lack X connections, or for IM Serverswhich do not use the X Window System, the preconnectionconvention with IM Server may be given outside the X Windowsystem (e.g. using a Name Service).4. ProtocolThe protocol described below uses the bi-directionalsynchronous/asynchronous request/reply/error model and isspecified using the same conventions outlined in Section 2of the core X Window System protocol [1]:4.1. Basic Requests Packet FormatThis section describes the requests that may be exchangedbetween the client and the IM Server.The basic request packet header format is as follows.major-opcode: CARD8minor-opcode: CARD8length: CARD16The MAJOR-OPCODE specifies which core request or extensionpackage this packet represents. If the MAJOR-OPCODEcorresponds to a core request, the MINOR-OPCODE contains 8bits of request-specific data. (If the MINOR-OPCODE is notused, it is 0.) Otherwise, the MAJOR-OPCODE and theMINOR-OPCODE are specified by XIM_QUERY_EXTENSION message.(Refer to 4.7. Query the supported extension protocol list.)The LENGTH field specifies the number of 4 bytes elementsfollowing the header. If no additional data is followed bythe header, the LENGTH field will be 0.4.2. Data TypesThe following data types are used in the core X IM Serverprotocol:BITMASK16CARD16BITMASK32CARD32PADDING FORMATWhere N is some expression, and Pad(N) is the number of bytes needed to round N up to amultiple of four.Pad(N) = (4 - (N mod 4)) mod 4LPCE1 A character from the4 X Portable Character Set in Latin PortableCharacter Encoding2</a><br>
<a href="#4.3. Error NotificationBoth the IM Server and the IM library return XIM_ERRORmessages instead of the corresponding reply messages if anyerrors occur during data processing.At most one error is generated per request. If more than oneerror condition is encountered in processing a request, thechoice of which error is returned isimplementation-dependent.(*1) Before an IM is created, both Input-Method-ID andInput-Context-ID are invalid. Before an IC iscreated, only Input-Method-ID is valid. Afterthat, both of Input-Method-ID and Input-Context-IDare valid.(*2) Unspecific error, for example &lsquo;&lsquo;language enginedied&rsquo;&rsquo;(*3) This field is reserved for future use.(*4) Vendor defined detail error message4.4. Connection EstablishmentXIM_CONNECT message requests to establish a connection overa mutually-understood virtual stream.(*1) Specify the version of IM Protocol that the clientsupports.A client must send XIM_CONNECT message as the first messageon the connection. The list specifies the names ofauthentication protocols the sending IM Server is willing toperform. (If the client need not authenticate, the list maybe omited.)XIM_AUTH_REQUIRED message is used to send the authenticationprotocol name and protocol-specific data.The auth-protocol is specified by an index into the list ofnames given in the XIM_CONNECT or XIM_AUTH_SETUP message.Any protocol-specific data that might be required is alsosent.The IM library sends XIM_AUTH_REPLY message as the reply toXIM_AUTH_REQUIRED message, if the IM Server isauthenticated.The auth data is specific to the authentication protocol inuse.XIM_AUTH_NEXT message requests to send more auth data.The auth data is specific to the authentication protocol inuse.The IM Server sends XIM_AUTH_SETUP message to authenticatethe client.The list specifies the names of authentication protocols theclient is willing to perform.XIM_AUTH_NG message requests to give up the connection.The IM Server sends XIM_CONNECT_REPLY message as the replyto XIM_CONNECT or XIM_AUTH_REQUIRED message.(*1) Specify the version of IM Protocol that the IMServer supports. This document specifies majorversion one, minor version zero.Here are the state diagrams for the client and the IMServer.State transitions for the clientinit_status:Use authorization function &rarr; client_askNot use authorization function &rarr; client_no_checkstart:Send XIM_CONNECTIf client_ask &rarr; client_wait1If client_no_check,client-auth-protocol-names may be omited &rarr;client_wait2client_wait1:Receive XIM_AUTH_REQUIRED &rarr; client_checkReceive &lt;other&gt; &rarr; client_NGclient_check:If no more auth needed, send XIM_AUTH_REPLY &rarr;client_wait2If good auth data, send XIM_AUTH_NEXT &rarr;client_wait1If bad auth data, send XIM_AUTH_NG &rarr; give up onthis protocolclient_wait2:Receive XIM_CONNECT_REPLY &rarr; connectReceive XIM_AUTH_SETUP &rarr; client_moreReceive XIM_AUTH_NEXT &rarr; client_moreReceive XIM_AUTH_NG &rarr; give up on this protocolReceive &lt;other&gt; &rarr; client_NGclient_more:Send XIM_AUTH_REQUIRED &rarr; client_wait2client_NG:Send XIM_AUTH_NG &rarr; give up on this protocolState transitions for the IM Serverinit-status:Use authorization function &rarr; server_askNot use authorization function &rarr; server_no_checkstart:Receive XIM_CONNECT &rarr; start2Receive &lt;other&gt; &rarr; server_NGstart2:If client_ask, send XIM_AUTH_REQUIRED &rarr;server_wait1If client_no_check and server_ask, sendXIM_AUTH_SETUP &rarr; server_wait2If client_no_check and server_no_check, sendXIM_CONNECT_REPLY &rarr; connectserver_wait1:Receive XIM_AUTH_REPLY &rarr; server2Receive XIM_AUTH_NEXT &rarr; server_moreReceive &lt;other&gt; &rarr; server_NGserver_moreSend XIM_AUTH_REQUIRED &rarr; server_wait1server2If server_ask, send XIM_AUTH_SETUP &rarr; server_wait2If server_no_check, send XIM_CONNECT_REPLY &rarr;connectserver_wait2Receive XIM_AUTH_REQUIRED &rarr; server_checkReceive &lt;other&gt; &rarr; server_NGserver_checkIf no more auth data, send XIM_CONNECT_REPLY &rarr;connectIf bad auth data, send XIM_AUTH_NG &rarr; give up onthis protocolIf good auth data, send XIM_AUTH_NEXT &rarr;server_wait2server_NGSend XIM_AUTH_NG &rarr; give up on this protocolXIM_DISCONNECT message requests to shutdown the connectionover a mutually-understood virtual stream.XIM_DISCONNECT is a synchronous request. The IM libraryshould wait until it receives either an XIM_DISCONNECT_REPLYpacket or an XIM_ERROR packet.XIM_OPEN requests to establish a logical connection betweenthe IM library and the IM Server.XIM_OPEN is a synchronous request. The IM library shouldwait until receiving either an XIM_OPEN_REPLY packet or anXIM_ERROR packet.XIM_OPEN_REPLY message returns all supported IM and ICattributes in LISTofXIMATTR and LISTofXICATTR. These IM andIC attribute IDs are used to reduce the amount of data whichmust be transferred via the network. In addition, thisindicates to the IM library what kinds of IM/IC attributescan be used in this session, and what types of data will beexchanged. This allows the IM Server provider andapplication writer to support IM system enhancements withnew IM/IC attributes, without modifying Xlib. The IC valuefor the separator of NestedList must be included in theLISTofXICATTR.XIM_CLOSE message requests to shutdown the logicalconnection between the IM library and the IM Server.XIM_CLOSE is a synchronous request. The IM library shouldwait until receiving either an XIM_CLOSE_REPLY packet or anXIM_ERROR packet.4.5. Event Flow ControlAn IM Server must send XIM_SET_EVENT_MASK message to the IMlibrary in order for events to be forwarded to the IMServer, since the IM library initially doesn&rsquo;t forward anyevents to the IM Server. In the protocol, the IM Server willspecify masks of X events to be forwarded and which need tobe synchronized by the IM library.(*1) Specify all the events to be forwarded to the IMServer by the IM library.(*2) Specify the events to be forwarded withsynchronous flag on by the IM library.XIM_SET_EVENT_MASK is an asynchronous request. The eventmasks are valid immediately after they are set until changedby another XIM_SET_EVENT_MASK message. If input-context-IDis set to zero, the default value of the input-method-IDwill be changed to the event masks specified in the request.That value will be used for the IC&rsquo;s which have noindividual values.Using the Dynamic Event Flow model, an IM Server sendsXIM_REGISTER_TRIGGERKEYS message to the IM library beforesending XIM_OPEN_REPLY message. Or the IM library maysuppose that the IM Server uses the Static Event Flow model.XIM_REGISTER_TRIGGERKEYS is an asynchronous request. The IMServer notifys the IM library of on-keys and off-keys listswith this message.The IM library notifys the IM Server with XIM_TRIGGER_NOTIFYmessage that a key event matching either on-keys or off-keyshas been occurred.(*1) Specify the events currently selected by the IMlibrary with XSelectInput.XIM_TRIGGER_NOTIFY is a synchronous request. The IM libraryshould wait until receiving either anXIM_TRIGGER_NOTIFY_REPLY packet or an XIM_ERROR packet.4.6. Encoding NegotiationXIM_ENCODING_NEGOTIATION message requests to decide whichencoding to be sent across the wire. When the negotiationfails, the fallback default encoding is Portable CharacterEncoding.The IM Server must choose one encoding from the list sent bythe IM library. If index of the encording determined is -1to indicate that the negotiation is failed, the fallbackdefault encoding is used. The message must be issued aftersending XIM_OPEN message via XOpenIM(). The name ofencoding may be registered with X Consortium.XIM_ENCODING_NEGOTIATION is a synchronous request. The IMlibrary should wait until receiving either anXIM_ENCODING_NEGOTIATION_REPLY packet or an XIM_ERRORpacket.4.7. Query the supported extension protocol listXIM_QUERY_EXTENSION message requests to query the IMextensions supported by the IM Server to which the client isbeing connected.An example of a supported extension is FrontEnd. Themessage must be issued after sending XIM_OPEN message viaXOpenIM().If n is 0, the IM library queries the IM Server for allextensions.If n is not 0, the IM library queries whether the IM Serversupports the contents specified in the list.If a client uses an extension request without previouslyhaving issued a XIM_QUERY_EXTENSION message for thatextension, the IM Server responds with a BadProtocol error.If the IM Server encounters a request with an unknownMAJOR-OPCODE or MINOR-OPCODE, it responds with a BadProtocolerror.XIM_QUERY_EXTENSION is a synchronous request. The IMlibrary should wait until receiving either anXIM_QUERY_EXTENSION_REPLY packet or an XIM_ERROR packet.XIM_QUERY_EXTENSION_REPLY message returns the list ofextensions supported by both the IM library and the IMServer. If the list passed in XIM_QUERY_EXTENSION message isNULL, the IM Server returns the full list of extensionssupported by the IM Server. If the list is not NULL, the IMServer returns the extensions in the list that are supportedby the IM Server.A zero-length string is not a valid extension name. The IMlibrary should disregard any zero-length strings that arereturned in the extension list. The IM library does not usethe requests which are not supported by the IM Server.4.8. Setting IM ValuesXIM_SET_IM_VALUES requests to set attributes to the IM.The im-attributes in XIM_SET_IM_VALUES message are specifiedas a LISTofXIMATTRIBUTE, specifying the attributes to beset. Attributes other than the ones returned byXIM_OPEN_REPLY message should not be specified.XIM_SET_IM_VALUES is a synchronous request. The IM libraryshould wait until receiving either anXIM_SET_IM_VALUES_REPLY packet or an XIM_ERROR packet,because it must receive the error attribute if XIM_ERRORmessage is returned.XIM_SET_IM_VALUES_REPLY message returns the input-method-IDto distinguish replies from multiple IMs.4.9. Getting IM ValuesXIM_GET_IM_VALUES requests to query IM values supported bythe IM Server currently being connected.XIM_GET_IM_VALUES is a synchronous request. The IM libraryshould wait until it receives either anXIM_GET_IM_VALUES_REPLY packet or an XIM_ERROR packet.The IM Server returns IM values with XIM_GET_IM_VALUES_REPLYmessage. The order of the returned im-attribute valuescorresponds directly to that of the list passed with theXIM_GET_IM_VALUES message.4.10. Creating an ICXIM_CREATE_IC message requests to create an IC.The input-context-id is specified by the IM Server toidentify the client (IC). (It is not specified by theclient in XIM_CREATE_IC message.), and it should not be setto zero.XIM_CREATE_IC is a synchronous request which returns theinput-context-ID. The IM library should wait until itreceives either an XIM_CREATE_IC_REPLY packet or anXIM_ERROR packet.4.11. Destroying the ICXIM_DESTROY_IC message requests to destroy the IC.XIM_DESTROY_IC is a synchronous request. The IM libraryshould not free its resources until it receives anXIM_DESTROY_IC_REPLY message because XIM_DESTROY_IC messagemay result in Callback packets such as XIM_PREEDIT_DRAW andXIM_PREEDIT_DONE.4.12. Setting IC ValuesXIM_SET_IC_VALUES messages requests to set attributes to theIC.The ic-attributes in XIM_SET_IC_VALUES message are specifiedas a LISTofXICATTRIBUTE, specifying the attributes to beset. Attributes other than the ones returned byXIM_OPEN_REPLY message should not be specified.XIM_SET_IC_VALUES is a synchronous request. The IM libraryshould wait until receiving either anXIM_SET_IC_VALUES_REPLY packet or an XIM_ERROR packet,because it must receive the error attribute if XIM_ERRORmessage is returned.4.13. Getting IC ValuesXIM_GET_IC_VALUES message requests to query IC valuessupported by the IM Server currently being connected.In LISTofCARD16, the appearance of the ic-attribute-id forthe separator of NestedList shows the end of the headingnested list.XIM_GET_IC_VALUES is a synchronous request and returns eachattribute with its values to show the correspondence. TheIM library should wait until receiving either anXIM_GET_IC_VALUES_REPLY packet or an XIM_ERROR packet.4.14. Setting IC FocusXIM_SET_IC_FOCUS message requests to set the focus to theIC.XIM_SET_IC_FOCUS is an asynchronous request.4.15. Unsetting IC FocusXIM_UNSET_IC_FOCUS message requests to unset the focus tothe focused IC.XIM_UNSET_IC_FOCUS is an asynchronous request.4.16. Filtering EventsEvent filtering is mainly provided for BackEnd method toallow input method to capture X events transparently toclients.X Events are forwarded by XIM_FORWARD_EVENT message. Thismessage can be operated both synchronously andasynchronously. If the requester sets the synchronous flag,the receiver must send XIM_SYNC_REPLY message back to therequester when all the data processing is done.Protocol flow of BackEnd modelWith BackEnd method, the protocol flow can be classifiedinto two methods in terms of synchronization, depending onthe synchronous-eventmask of XIM_SET_EVENT_MASK message.One can be called on-demand-synchronous method and anothercan be called as full-synchronous method.In on-demand-synchronous method, the IM library alwaysreceives XIM_FORWARD_EVENT or XIM_COMMIT message as asynchronous request. Also, the IM Server needs tosynchronously process the correspondent reply from the IMlibrary and the following XIM_FORWARD_EVENT message sentfrom the IM library when any of the event causes the IMServer to send XIM_FORWARD_EVENT or XIM_COMMIT message tothe IM library, so that the input service is consistent. Ifthe IM library gets the control back from the applicationafter receiving the synchronous request, the IM libraryreplies for the synchronous request before processing any ofthe events. In this time, the IM Server blocksXIM_FORWARD_EVENT message which is sent by the IM library,and handles it after receiving the reply. However, the IMServer handles the other protocols at any time.In full-synchronous method, the IM library always sendsXIM_FORWARD_EVENT message to the IM Server as a synchronousrequest. Therefore, the reply to it from the IM Server willbe put between the XIM_FORWARD_EVENT message and itsXIM_SYNC_REPLY message. In case of sendingXIM_FORWARD_EVENT or XIM_COMMIT message, the IM Servershould set the synchronous flag off. Because thesynchronization can be done by the following XIM_SYNC_REPLYmessage.Sample Protocol flow chart 1Following chart shows one of the simplest protocol flowwhich only deals with keyevents for preediting operation.... 0.425 6.888 6.3 10.296 ... 0.000i 3.408i 5.875i 0.000iFig.2 Sample Protocol FlowSample Protocol flow chart 2Following chart shows one of the complex protocol flow,which deals with multiple focus windows and button pressevent as well as keyevent, and the focus is moved by theapplication triggered by both of keyevent and button pressevent. 4">4.3. Error NotificationBoth the IM Server and the IM library return XIM_ERRORmessages instead of the corresponding reply messages if anyerrors occur during data processing.At most one error is generated per request. If more than oneerror condition is encountered in processing a request, thechoice of which error is returned isimplementation-dependent.(*1) Before an IM is created, both Input-Method-ID andInput-Context-ID are invalid. Before an IC iscreated, only Input-Method-ID is valid. Afterthat, both of Input-Method-ID and Input-Context-IDare valid.(*2) Unspecific error, for example &lsquo;&lsquo;language enginedied&rsquo;&rsquo;(*3) This field is reserved for future use.(*4) Vendor defined detail error message4.4. Connection EstablishmentXIM_CONNECT message requests to establish a connection overa mutually-understood virtual stream.(*1) Specify the version of IM Protocol that the clientsupports.A client must send XIM_CONNECT message as the first messageon the connection. The list specifies the names ofauthentication protocols the sending IM Server is willing toperform. (If the client need not authenticate, the list maybe omited.)XIM_AUTH_REQUIRED message is used to send the authenticationprotocol name and protocol-specific data.The auth-protocol is specified by an index into the list ofnames given in the XIM_CONNECT or XIM_AUTH_SETUP message.Any protocol-specific data that might be required is alsosent.The IM library sends XIM_AUTH_REPLY message as the reply toXIM_AUTH_REQUIRED message, if the IM Server isauthenticated.The auth data is specific to the authentication protocol inuse.XIM_AUTH_NEXT message requests to send more auth data.The auth data is specific to the authentication protocol inuse.The IM Server sends XIM_AUTH_SETUP message to authenticatethe client.The list specifies the names of authentication protocols theclient is willing to perform.XIM_AUTH_NG message requests to give up the connection.The IM Server sends XIM_CONNECT_REPLY message as the replyto XIM_CONNECT or XIM_AUTH_REQUIRED message.(*1) Specify the version of IM Protocol that the IMServer supports. This document specifies majorversion one, minor version zero.Here are the state diagrams for the client and the IMServer.State transitions for the clientinit_status:Use authorization function &rarr; client_askNot use authorization function &rarr; client_no_checkstart:Send XIM_CONNECTIf client_ask &rarr; client_wait1If client_no_check,client-auth-protocol-names may be omited &rarr;client_wait2client_wait1:Receive XIM_AUTH_REQUIRED &rarr; client_checkReceive &lt;other&gt; &rarr; client_NGclient_check:If no more auth needed, send XIM_AUTH_REPLY &rarr;client_wait2If good auth data, send XIM_AUTH_NEXT &rarr;client_wait1If bad auth data, send XIM_AUTH_NG &rarr; give up onthis protocolclient_wait2:Receive XIM_CONNECT_REPLY &rarr; connectReceive XIM_AUTH_SETUP &rarr; client_moreReceive XIM_AUTH_NEXT &rarr; client_moreReceive XIM_AUTH_NG &rarr; give up on this protocolReceive &lt;other&gt; &rarr; client_NGclient_more:Send XIM_AUTH_REQUIRED &rarr; client_wait2client_NG:Send XIM_AUTH_NG &rarr; give up on this protocolState transitions for the IM Serverinit-status:Use authorization function &rarr; server_askNot use authorization function &rarr; server_no_checkstart:Receive XIM_CONNECT &rarr; start2Receive &lt;other&gt; &rarr; server_NGstart2:If client_ask, send XIM_AUTH_REQUIRED &rarr;server_wait1If client_no_check and server_ask, sendXIM_AUTH_SETUP &rarr; server_wait2If client_no_check and server_no_check, sendXIM_CONNECT_REPLY &rarr; connectserver_wait1:Receive XIM_AUTH_REPLY &rarr; server2Receive XIM_AUTH_NEXT &rarr; server_moreReceive &lt;other&gt; &rarr; server_NGserver_moreSend XIM_AUTH_REQUIRED &rarr; server_wait1server2If server_ask, send XIM_AUTH_SETUP &rarr; server_wait2If server_no_check, send XIM_CONNECT_REPLY &rarr;connectserver_wait2Receive XIM_AUTH_REQUIRED &rarr; server_checkReceive &lt;other&gt; &rarr; server_NGserver_checkIf no more auth data, send XIM_CONNECT_REPLY &rarr;connectIf bad auth data, send XIM_AUTH_NG &rarr; give up onthis protocolIf good auth data, send XIM_AUTH_NEXT &rarr;server_wait2server_NGSend XIM_AUTH_NG &rarr; give up on this protocolXIM_DISCONNECT message requests to shutdown the connectionover a mutually-understood virtual stream.XIM_DISCONNECT is a synchronous request. The IM libraryshould wait until it receives either an XIM_DISCONNECT_REPLYpacket or an XIM_ERROR packet.XIM_OPEN requests to establish a logical connection betweenthe IM library and the IM Server.XIM_OPEN is a synchronous request. The IM library shouldwait until receiving either an XIM_OPEN_REPLY packet or anXIM_ERROR packet.XIM_OPEN_REPLY message returns all supported IM and ICattributes in LISTofXIMATTR and LISTofXICATTR. These IM andIC attribute IDs are used to reduce the amount of data whichmust be transferred via the network. In addition, thisindicates to the IM library what kinds of IM/IC attributescan be used in this session, and what types of data will beexchanged. This allows the IM Server provider andapplication writer to support IM system enhancements withnew IM/IC attributes, without modifying Xlib. The IC valuefor the separator of NestedList must be included in theLISTofXICATTR.XIM_CLOSE message requests to shutdown the logicalconnection between the IM library and the IM Server.XIM_CLOSE is a synchronous request. The IM library shouldwait until receiving either an XIM_CLOSE_REPLY packet or anXIM_ERROR packet.4.5. Event Flow ControlAn IM Server must send XIM_SET_EVENT_MASK message to the IMlibrary in order for events to be forwarded to the IMServer, since the IM library initially doesn&rsquo;t forward anyevents to the IM Server. In the protocol, the IM Server willspecify masks of X events to be forwarded and which need tobe synchronized by the IM library.(*1) Specify all the events to be forwarded to the IMServer by the IM library.(*2) Specify the events to be forwarded withsynchronous flag on by the IM library.XIM_SET_EVENT_MASK is an asynchronous request. The eventmasks are valid immediately after they are set until changedby another XIM_SET_EVENT_MASK message. If input-context-IDis set to zero, the default value of the input-method-IDwill be changed to the event masks specified in the request.That value will be used for the IC&rsquo;s which have noindividual values.Using the Dynamic Event Flow model, an IM Server sendsXIM_REGISTER_TRIGGERKEYS message to the IM library beforesending XIM_OPEN_REPLY message. Or the IM library maysuppose that the IM Server uses the Static Event Flow model.XIM_REGISTER_TRIGGERKEYS is an asynchronous request. The IMServer notifys the IM library of on-keys and off-keys listswith this message.The IM library notifys the IM Server with XIM_TRIGGER_NOTIFYmessage that a key event matching either on-keys or off-keyshas been occurred.(*1) Specify the events currently selected by the IMlibrary with XSelectInput.XIM_TRIGGER_NOTIFY is a synchronous request. The IM libraryshould wait until receiving either anXIM_TRIGGER_NOTIFY_REPLY packet or an XIM_ERROR packet.4.6. Encoding NegotiationXIM_ENCODING_NEGOTIATION message requests to decide whichencoding to be sent across the wire. When the negotiationfails, the fallback default encoding is Portable CharacterEncoding.The IM Server must choose one encoding from the list sent bythe IM library. If index of the encording determined is -1to indicate that the negotiation is failed, the fallbackdefault encoding is used. The message must be issued aftersending XIM_OPEN message via XOpenIM(). The name ofencoding may be registered with X Consortium.XIM_ENCODING_NEGOTIATION is a synchronous request. The IMlibrary should wait until receiving either anXIM_ENCODING_NEGOTIATION_REPLY packet or an XIM_ERRORpacket.4.7. Query the supported extension protocol listXIM_QUERY_EXTENSION message requests to query the IMextensions supported by the IM Server to which the client isbeing connected.An example of a supported extension is FrontEnd. Themessage must be issued after sending XIM_OPEN message viaXOpenIM().If n is 0, the IM library queries the IM Server for allextensions.If n is not 0, the IM library queries whether the IM Serversupports the contents specified in the list.If a client uses an extension request without previouslyhaving issued a XIM_QUERY_EXTENSION message for thatextension, the IM Server responds with a BadProtocol error.If the IM Server encounters a request with an unknownMAJOR-OPCODE or MINOR-OPCODE, it responds with a BadProtocolerror.XIM_QUERY_EXTENSION is a synchronous request. The IMlibrary should wait until receiving either anXIM_QUERY_EXTENSION_REPLY packet or an XIM_ERROR packet.XIM_QUERY_EXTENSION_REPLY message returns the list ofextensions supported by both the IM library and the IMServer. If the list passed in XIM_QUERY_EXTENSION message isNULL, the IM Server returns the full list of extensionssupported by the IM Server. If the list is not NULL, the IMServer returns the extensions in the list that are supportedby the IM Server.A zero-length string is not a valid extension name. The IMlibrary should disregard any zero-length strings that arereturned in the extension list. The IM library does not usethe requests which are not supported by the IM Server.4.8. Setting IM ValuesXIM_SET_IM_VALUES requests to set attributes to the IM.The im-attributes in XIM_SET_IM_VALUES message are specifiedas a LISTofXIMATTRIBUTE, specifying the attributes to beset. Attributes other than the ones returned byXIM_OPEN_REPLY message should not be specified.XIM_SET_IM_VALUES is a synchronous request. The IM libraryshould wait until receiving either anXIM_SET_IM_VALUES_REPLY packet or an XIM_ERROR packet,because it must receive the error attribute if XIM_ERRORmessage is returned.XIM_SET_IM_VALUES_REPLY message returns the input-method-IDto distinguish replies from multiple IMs.4.9. Getting IM ValuesXIM_GET_IM_VALUES requests to query IM values supported bythe IM Server currently being connected.XIM_GET_IM_VALUES is a synchronous request. The IM libraryshould wait until it receives either anXIM_GET_IM_VALUES_REPLY packet or an XIM_ERROR packet.The IM Server returns IM values with XIM_GET_IM_VALUES_REPLYmessage. The order of the returned im-attribute valuescorresponds directly to that of the list passed with theXIM_GET_IM_VALUES message.4.10. Creating an ICXIM_CREATE_IC message requests to create an IC.The input-context-id is specified by the IM Server toidentify the client (IC). (It is not specified by theclient in XIM_CREATE_IC message.), and it should not be setto zero.XIM_CREATE_IC is a synchronous request which returns theinput-context-ID. The IM library should wait until itreceives either an XIM_CREATE_IC_REPLY packet or anXIM_ERROR packet.4.11. Destroying the ICXIM_DESTROY_IC message requests to destroy the IC.XIM_DESTROY_IC is a synchronous request. The IM libraryshould not free its resources until it receives anXIM_DESTROY_IC_REPLY message because XIM_DESTROY_IC messagemay result in Callback packets such as XIM_PREEDIT_DRAW andXIM_PREEDIT_DONE.4.12. Setting IC ValuesXIM_SET_IC_VALUES messages requests to set attributes to theIC.The ic-attributes in XIM_SET_IC_VALUES message are specifiedas a LISTofXICATTRIBUTE, specifying the attributes to beset. Attributes other than the ones returned byXIM_OPEN_REPLY message should not be specified.XIM_SET_IC_VALUES is a synchronous request. The IM libraryshould wait until receiving either anXIM_SET_IC_VALUES_REPLY packet or an XIM_ERROR packet,because it must receive the error attribute if XIM_ERRORmessage is returned.4.13. Getting IC ValuesXIM_GET_IC_VALUES message requests to query IC valuessupported by the IM Server currently being connected.In LISTofCARD16, the appearance of the ic-attribute-id forthe separator of NestedList shows the end of the headingnested list.XIM_GET_IC_VALUES is a synchronous request and returns eachattribute with its values to show the correspondence. TheIM library should wait until receiving either anXIM_GET_IC_VALUES_REPLY packet or an XIM_ERROR packet.4.14. Setting IC FocusXIM_SET_IC_FOCUS message requests to set the focus to theIC.XIM_SET_IC_FOCUS is an asynchronous request.4.15. Unsetting IC FocusXIM_UNSET_IC_FOCUS message requests to unset the focus tothe focused IC.XIM_UNSET_IC_FOCUS is an asynchronous request.4.16. Filtering EventsEvent filtering is mainly provided for BackEnd method toallow input method to capture X events transparently toclients.X Events are forwarded by XIM_FORWARD_EVENT message. Thismessage can be operated both synchronously andasynchronously. If the requester sets the synchronous flag,the receiver must send XIM_SYNC_REPLY message back to therequester when all the data processing is done.Protocol flow of BackEnd modelWith BackEnd method, the protocol flow can be classifiedinto two methods in terms of synchronization, depending onthe synchronous-eventmask of XIM_SET_EVENT_MASK message.One can be called on-demand-synchronous method and anothercan be called as full-synchronous method.In on-demand-synchronous method, the IM library alwaysreceives XIM_FORWARD_EVENT or XIM_COMMIT message as asynchronous request. Also, the IM Server needs tosynchronously process the correspondent reply from the IMlibrary and the following XIM_FORWARD_EVENT message sentfrom the IM library when any of the event causes the IMServer to send XIM_FORWARD_EVENT or XIM_COMMIT message tothe IM library, so that the input service is consistent. Ifthe IM library gets the control back from the applicationafter receiving the synchronous request, the IM libraryreplies for the synchronous request before processing any ofthe events. In this time, the IM Server blocksXIM_FORWARD_EVENT message which is sent by the IM library,and handles it after receiving the reply. However, the IMServer handles the other protocols at any time.In full-synchronous method, the IM library always sendsXIM_FORWARD_EVENT message to the IM Server as a synchronousrequest. Therefore, the reply to it from the IM Server willbe put between the XIM_FORWARD_EVENT message and itsXIM_SYNC_REPLY message. In case of sendingXIM_FORWARD_EVENT or XIM_COMMIT message, the IM Servershould set the synchronous flag off. Because thesynchronization can be done by the following XIM_SYNC_REPLYmessage.Sample Protocol flow chart 1Following chart shows one of the simplest protocol flowwhich only deals with keyevents for preediting operation.... 0.425 6.888 6.3 10.296 ... 0.000i 3.408i 5.875i 0.000iFig.2 Sample Protocol FlowSample Protocol flow chart 2Following chart shows one of the complex protocol flow,which deals with multiple focus windows and button pressevent as well as keyevent, and the focus is moved by theapplication triggered by both of keyevent and button pressevent. 4</a><br>
<a href="#4.17. Synchronizing with the IM ServerXIM_SYNC message requests to synchronize the IM library andthe IM Server.This synchronization can be started either on the IM libraryside or on the IM Server side. The side which receivesXIM_SYNC message should process all XIM requests beforereplying. The input-context-ID is necessary to distinguishthe IC with which the IM library and the IM Server aresynchronized.The side which receives XIM_FORWARD_EVENT, XIM_COMMIT or anyother message with synchronous bit, should process all XIMrequest before replying, and send XIM_SYNC_REPLY message asthe reply to the previous message.4.18. Sending a committed stringWhen the IM Server commits a string, the IM Server sendseither the committed string or list of KeySym, or both, byXIM_COMMIT message.If flag is XLookupKeySym, the arguments continue asfollows:If flag is XLookupChars, the arguments continue asfollows:If flag is XLookupBoth, the arguments continue asfollows:The IM Server which receives XIM_COMMIT message withoutsynchronous bit should set synchronous bit.4.19. Reset ICXIM_RESET_IC message requests to reset the status of IC inthe IM Server.XIM_RESET_IC is a synchronous request. The IM library shouldwait until receiving either an XIM_RESET_IC_REPLY packet oran XIM_ERROR packet.XIM_RESET_IC_REPLY message returns the input-context-ID todistinguish replies from multiple ICs.4.20. CallbacksIf XIMStyle has XIMPreeditArea or XIMStatusArea set,XIMGeometryCallback may be used, and if XIMPreeditCallbackand/or XIMStatusCallback are set, corresponding callbacksmay be used.Any callback request may be sent from an IM Server to an IMclient asynchronously in response to any request previouslysent by the IM client to the IM Server.When an IM Server needs to send a callback requestsynchronously with the request previously sent by an IMclient, the IM Server sends it before replying to theprevious request.4.20.1. Negotiating geometryThe IM Server sends XIM_GEOMETRY message to start geometrynegotiation, if XIMStyle has XIMPreeditArea or XIMStatusAreaset.There is always a single Focus Window, even if some inputfields have only one IC.4.20.2. Converting a stringXIM_STR_CONVERSION message may be used to start the stringconversion from the IM Server.XIM_STR_CONVERSION_REPLY message returns the string to beconverted and the feedback information array.4.20.3. Preedit CallbacksThe IM Server sends XIM_PREEDIT_START message to call theXIMPreeditStartCallback function.The reply to this message must be sent synchronously. Thereply forwards the return value from the callback functionto the IM Server.XIM_PREEDIT_START_REPLY message returns the input-context-IDto distinguish replies from multiple IC&rsquo;s. The return valuecontains the return value of the functionXIMPreeditStartCallback.The IM Server sends XIM_PREEDIT_DRAW message to call theXIMPreeditDrawCallback function.The fields &lsquo;&lsquo;caret&rsquo;&rsquo;, &lsquo;&lsquo;chg_first&rsquo;&rsquo; and &lsquo;&lsquo;chg_length&rsquo;&rsquo;correspond to the fields of XIMPreeditDrawCallbackStruct.When the &lsquo;&lsquo;no string&rsquo;&rsquo; bit of the status field is set, thetext field of XIMPreeditDrawCallbackStruct is NULL. Whenthe &lsquo;&lsquo;no feedback&rsquo;&rsquo; bit of the status field is set, the textfeedback field of XIMPreeditDrawCallbackStruct is NULL.When the above bits are not set, &lsquo;&lsquo;preedit string&rsquo;&rsquo; containsthe preedit string to be displayed, and the feedback arraycontains feedback information.The IM Server sends XIM_PREEDIT_CARET message to call thePreeditCaretCallback function.Each entry corresponds to a field ofXIMPreeditCaretCallbackStruct. Since this callback sets thecaret position, its reply must be sent synchronously.The position is the value returned by the callback functionafter it has been called.The IM Server sends XIM_PREEDIT_DONE message to call theXIMPreeditDoneCallback function.4.20.4. Preedit state notifyXIM_PREEDITSTATE message is used to call theXIMPreeditStateNotifyCallback function.4.20.5. Status CallbacksThe IM Server sends XIM_STATUS_START message to call theXIMStatusStartCallback function.XIM_STATUS_START (IM Server &rarr; IM library)2 CARD16 input-method-ID2 CARD16 input-context-IDThe IM Server sends XIM_STATUS_DRAW message to call theXIMStatusDrawCallback function.XIM_STATUS_DRAW (IM Server &rarr; IM library)2 CARD16 input-method-ID2 CARD16 input-context-ID4 CARD32 type#0 XIMTextType#1 XIMBitmapTypeIf type is XIMTextType, the arguments continue asfollows.4 BITMASK32 status#x0000001 no string#x0000002 no feedback2 n length of status stringn STRING8 status stringp unused, p = Pad(2+n)2 m byte length of feedback array2 unusedm LISTofXIMFEEDBACK feedback arrayIf type is XIMBitmapType, the arguments continue asfollows.4 PIXMAP pixmap dataThe field &lsquo;&lsquo;type&rsquo;&rsquo; corresponds to the field inXIMStatusDrawCallbackStruct.The IM Server sends XIM_STATUS_DONE message to call theXIMStatusDoneCallback function.XIM_STATUS_DONE (IM Server &rarr; IM library)2 CARD16 input-method-ID2 CARD16 input-context-ID5">4.17. Synchronizing with the IM ServerXIM_SYNC message requests to synchronize the IM library andthe IM Server.This synchronization can be started either on the IM libraryside or on the IM Server side. The side which receivesXIM_SYNC message should process all XIM requests beforereplying. The input-context-ID is necessary to distinguishthe IC with which the IM library and the IM Server aresynchronized.The side which receives XIM_FORWARD_EVENT, XIM_COMMIT or anyother message with synchronous bit, should process all XIMrequest before replying, and send XIM_SYNC_REPLY message asthe reply to the previous message.4.18. Sending a committed stringWhen the IM Server commits a string, the IM Server sendseither the committed string or list of KeySym, or both, byXIM_COMMIT message.If flag is XLookupKeySym, the arguments continue asfollows:If flag is XLookupChars, the arguments continue asfollows:If flag is XLookupBoth, the arguments continue asfollows:The IM Server which receives XIM_COMMIT message withoutsynchronous bit should set synchronous bit.4.19. Reset ICXIM_RESET_IC message requests to reset the status of IC inthe IM Server.XIM_RESET_IC is a synchronous request. The IM library shouldwait until receiving either an XIM_RESET_IC_REPLY packet oran XIM_ERROR packet.XIM_RESET_IC_REPLY message returns the input-context-ID todistinguish replies from multiple ICs.4.20. CallbacksIf XIMStyle has XIMPreeditArea or XIMStatusArea set,XIMGeometryCallback may be used, and if XIMPreeditCallbackand/or XIMStatusCallback are set, corresponding callbacksmay be used.Any callback request may be sent from an IM Server to an IMclient asynchronously in response to any request previouslysent by the IM client to the IM Server.When an IM Server needs to send a callback requestsynchronously with the request previously sent by an IMclient, the IM Server sends it before replying to theprevious request.4.20.1. Negotiating geometryThe IM Server sends XIM_GEOMETRY message to start geometrynegotiation, if XIMStyle has XIMPreeditArea or XIMStatusAreaset.There is always a single Focus Window, even if some inputfields have only one IC.4.20.2. Converting a stringXIM_STR_CONVERSION message may be used to start the stringconversion from the IM Server.XIM_STR_CONVERSION_REPLY message returns the string to beconverted and the feedback information array.4.20.3. Preedit CallbacksThe IM Server sends XIM_PREEDIT_START message to call theXIMPreeditStartCallback function.The reply to this message must be sent synchronously. Thereply forwards the return value from the callback functionto the IM Server.XIM_PREEDIT_START_REPLY message returns the input-context-IDto distinguish replies from multiple IC&rsquo;s. The return valuecontains the return value of the functionXIMPreeditStartCallback.The IM Server sends XIM_PREEDIT_DRAW message to call theXIMPreeditDrawCallback function.The fields &lsquo;&lsquo;caret&rsquo;&rsquo;, &lsquo;&lsquo;chg_first&rsquo;&rsquo; and &lsquo;&lsquo;chg_length&rsquo;&rsquo;correspond to the fields of XIMPreeditDrawCallbackStruct.When the &lsquo;&lsquo;no string&rsquo;&rsquo; bit of the status field is set, thetext field of XIMPreeditDrawCallbackStruct is NULL. Whenthe &lsquo;&lsquo;no feedback&rsquo;&rsquo; bit of the status field is set, the textfeedback field of XIMPreeditDrawCallbackStruct is NULL.When the above bits are not set, &lsquo;&lsquo;preedit string&rsquo;&rsquo; containsthe preedit string to be displayed, and the feedback arraycontains feedback information.The IM Server sends XIM_PREEDIT_CARET message to call thePreeditCaretCallback function.Each entry corresponds to a field ofXIMPreeditCaretCallbackStruct. Since this callback sets thecaret position, its reply must be sent synchronously.The position is the value returned by the callback functionafter it has been called.The IM Server sends XIM_PREEDIT_DONE message to call theXIMPreeditDoneCallback function.4.20.4. Preedit state notifyXIM_PREEDITSTATE message is used to call theXIMPreeditStateNotifyCallback function.4.20.5. Status CallbacksThe IM Server sends XIM_STATUS_START message to call theXIMStatusStartCallback function.XIM_STATUS_START (IM Server &rarr; IM library)2 CARD16 input-method-ID2 CARD16 input-context-IDThe IM Server sends XIM_STATUS_DRAW message to call theXIMStatusDrawCallback function.XIM_STATUS_DRAW (IM Server &rarr; IM library)2 CARD16 input-method-ID2 CARD16 input-context-ID4 CARD32 type#0 XIMTextType#1 XIMBitmapTypeIf type is XIMTextType, the arguments continue asfollows.4 BITMASK32 status#x0000001 no string#x0000002 no feedback2 n length of status stringn STRING8 status stringp unused, p = Pad(2+n)2 m byte length of feedback array2 unusedm LISTofXIMFEEDBACK feedback arrayIf type is XIMBitmapType, the arguments continue asfollows.4 PIXMAP pixmap dataThe field &lsquo;&lsquo;type&rsquo;&rsquo; corresponds to the field inXIMStatusDrawCallbackStruct.The IM Server sends XIM_STATUS_DONE message to call theXIMStatusDoneCallback function.XIM_STATUS_DONE (IM Server &rarr; IM library)2 CARD16 input-method-ID2 CARD16 input-context-ID5</a><br>
<a href="#5. AcknowledgementsThis document represents the culmination of several years ofdebate and experiments done under the auspices of the MIT XConsortium i18n working group. Although this was a groupeffort, the author remains responsible for any errors oromissions.We would like to thank to all members of this group. And wewould like to make special thanks to the following people(in alphabetical order) for their participation in the IMProtocol design, Hector Chan, Takashi Fujiwara, YoshioHoriuchi, Makoto Inada, Hiromu Inukai, Mickael Kung, SeijiKuwari, Franky Ling, Hiroyuki Machida, Hiroyuki Miyamoto,Frank Rojas, Bob Scheifler, Makiko Shimamura, ShojiSugiyama, Hidetoshi Tajima, Masaki Takeuchi, MakotoWakamatsu, Masaki Wakao, Nobuyuki Tanaka, Shigeru Yamada,Katsuhisa Yano, Jinsoo Yoon.6. ReferencesAll of the following documents are X Consortium standardsavailable from MIT:[1] Scheifler, Robert W., &lsquo;&lsquo;X Window System Protocol Version11&rsquo;&rsquo;[2] Scheifler, Robert W. etc., &lsquo;&lsquo;Xlib &minus; C Language XInterface&rsquo;&rsquo; 6">5. AcknowledgementsThis document represents the culmination of several years ofdebate and experiments done under the auspices of the MIT XConsortium i18n working group. Although this was a groupeffort, the author remains responsible for any errors oromissions.We would like to thank to all members of this group. And wewould like to make special thanks to the following people(in alphabetical order) for their participation in the IMProtocol design, Hector Chan, Takashi Fujiwara, YoshioHoriuchi, Makoto Inada, Hiromu Inukai, Mickael Kung, SeijiKuwari, Franky Ling, Hiroyuki Machida, Hiroyuki Miyamoto,Frank Rojas, Bob Scheifler, Makiko Shimamura, ShojiSugiyama, Hidetoshi Tajima, Masaki Takeuchi, MakotoWakamatsu, Masaki Wakao, Nobuyuki Tanaka, Shigeru Yamada,Katsuhisa Yano, Jinsoo Yoon.6. ReferencesAll of the following documents are X Consortium standardsavailable from MIT:[1] Scheifler, Robert W., &lsquo;&lsquo;X Window System Protocol Version11&rsquo;&rsquo;[2] Scheifler, Robert W. etc., &lsquo;&lsquo;Xlib &minus; C Language XInterface&rsquo;&rsquo; 6</a><br>

<hr>


<p align="center"><i>Masahiko Narita</i> <br>
FUJITSU Limited. <i><br>
Hideki Hiura</i> <br>
SunSoft, Inc.</p>


<p align="center" style="margin-top: 1em"><i>ABSTRACT</i></p>

<p style="margin-top: 1em">This specifies a protocol
between IM library and IM (Input Method) Server for
internationalized text input, which is independent from any
specific language, any specific input method and the
transport layer used in communication between the IM library
and the IM Server, and uses a client-server model. This
protocol allows user to use his/her favorite input method
for all applications within the stand-alone distributed
environment.</p>

<p align="center" style="margin-top: 1em">X Window System
is a trademark of X Consortium, Inc.</p>

<p align="center" style="margin-top: 1em">Copyright &copy;
1993, 1994 by X Consortium, Inc.</p>

<p style="margin-top: 1em">Permission is hereby granted,
free of charge, to any person obtaining a copy of this
software and associated documentation files (the
&quot;Software&quot;), to deal in the Software without
restriction, including without limitation the rights to use,
copy, modify, merge, publish, distribute, sublicense, and/or
sell copies of the Software, and to permit persons to whom
the Software is furnished to do so, subject to the following
conditions:</p>

<p style="margin-top: 1em">The above copyright notice and
this permission notice shall be included in all copies or
substantial portions of the Software.</p>

<p style="margin-top: 1em">THE SOFTWARE IS PROVIDED
&quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
NONINFRINGEMENT. IN NO EVENT SHALL THE X CONSORTIUM BE
LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN
AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT
OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
DEALINGS IN THE SOFTWARE.</p>

<p style="margin-top: 1em">Except as contained in this
notice, the name of the X Consortium shall not be used in
advertising or otherwise to promote the sale, use or other
dealings in this Software without prior written
authorization from the X Consortium.</p>

<p align="center" style="margin-top: 1em">Copyright &copy;
1993, 1994 by FUJITSU LIMITED</p>

<p align="center" style="margin-top: 1em">Copyright &copy;
1993, 1994 by Sun Microsystems, Inc.</p>

<p style="margin-top: 1em">Permission to use, copy, modify,
and distribute this documentation for any purpose and
without fee is hereby granted, provided that the above
copyright notice and this permission notice appear in all
copies. Fujitsu and Sun Microsystems make no representations
about the suitability for any purpose of the information in
this document. This documentation is provided as is without
express or implied warranty.</p>

<h2>1. Introduction1.1. ScopeThe internationalization in the X Window System Version 11,Release 5 (X11R5) provides a common API which applicationdevelopers can use to create portable internationalizedprograms and to adapt them to the requirements of differentnative languages, local customs, and character stringencodings (this is called &lsquo;&lsquo;localization&rsquo;&rsquo;). As one of itsinternationalization mechanisms X11R5 has defined afunctional interface for internationalized text input,called XIM (X Input Method).When a client-server model is used with an IM (Input Method)implementation, a protocol must be established between theclient and the server. However, the protocol used tointerface Input Method Servers (IM Servers) with the InputMethod libraries (IM libraries) to which applications arelinked was not addressed in X11R5. This led applicationdevelopers to depend on vendor-specific input methods,decreased the user&rsquo;s choice of available input methods, andmade it more difficult for developers to create portableapplications. This paper describes the Input Method Protocoldeveloped for X11R6 to resolve the above problems and toaddress the requirements of existing and future inputmethods.The Input Method Protocol is independent from the transportlayer used in communication between the IM library and theIM Server. Thus, the input method protocol can be built onany inter-process communication mechanism, such as TCP/IP orthe X protocol.In addition, the protocol provides for future extensionssuch as differing input model types.1.2. BackgroundText input is much more simple for some languages thanothers. English, for instance, uses an alphabet of amanageable size, and input consists of pressing thecorresponding key on a keyboard, perhaps in combination witha shift key for capital letters or special characters.Some languages have larger alphabets, or modifiers such asaccents, which require the addition of special keycombinations in order to enter text. These input methodsmay require &lsquo;&lsquo;dead-keys&rsquo;&rsquo; or &lsquo;&lsquo;compose-keys&rsquo;&rsquo; which, whenfollowed by different combinations of key strokes, generatedifferent characters.Text input for ideographic languages is much less simple.In these languages, characters represent actual objectsrather than phonetic sounds used in pronouncing a word, andthe number of characters in these languages may continue togrow. In Japanese, for instance, most text input methodsinvolve entering characters in a phonetic alphabet, afterwhich the input method searches a dictionary for possibleideographic equivalents (of which there may be many). Theinput method then presents the candidate characters for theuser to choose from.In Japanese, either Kana (phonetic symbols) or Roman lettersare typed and then a region is selected for conversion toKanji. Several Kanji characters may have the same phoneticrepresentation. If that is the case with the string entered,a menu of characters is presented and the user must choosethe appropriate one. If no choice is necessary or apreference has been established, the input method does thesubstitution directly.These complicated input methods must present stateinformation (Status Area), text entry and edit space(Preedit Area), and menu/choice presentations (AuxiliaryArea). Much of the protocol between the IM library and theIM Server involves managing these IM areas. Because of thesize and complexity of these input methods, and because ofhow widely they vary from one language or locale to another,they are usually implemented as separate processes which canserve many client processes on the same computer or network.1.3. Input Method StylesX11 internationalization support includes the following fourtypes of input method:- on-the-spot: The client application is directedby the IM Server to display allpre-edit data at the site of textinsertion. The client registerscallbacks invoked by the inputmethod during pre-editing.- off-the-spot: The client application providesdisplay windows for the pre-editdata to the input method whichdisplays into them directly.- over-the-spot: The input method displays pre-editdata in a window which it brings updirectly over the text insertionposition.- root-window: The input method displays allpre-edit data in a separate area ofthe screen in a window specific tothe input method.Client applications must choose from the available inputmethods supported by the IM Server and provide the displayareas and callbacks required by the input method.2. Architecture2.1. Implementation ModelWithin the X Window System environment, the following twotypical architectural models can be used as an inputmethod&rsquo;s implementation model.- Client/Server model:A separate process, the IM Server,processes input and handlespreediting, converting, andcommitting. The IM library withinthe application, acting as clientto the IM Server, simply receivesthe committed string from the IMServer.- Library model: All input is handled by the IMlibrary within the application.The event process is closed withinthe IM library and a separate IMServer process may not be required.Most languages which need complex preediting, such as Asianlanguages, are implemented using the Client/Server IM model.Other languages which need only dead key or compose keyprocessing, such as European languages, are implementedusing the Library model.In this paper, we discuss mainly the Client/Server IM modeland the protocol used in communication between the IMlibrary (client) and the IM Server.2.2. Structure of IMWhen the client connects or disconnects to the IM Server, anopen or close operation occurs between the client and the IMServer.The IM can be specified at the time of XOpenIM() by settingthe locale of the client and a locale modifier. Since the IMremembers the locale at the time of creation XOpenIM() canbe called multiple times (with the setting for the localeand the locale modifier changed) to support multiplelanguages.In addition, the supported IM type can be obtained usingXGetIMValues().The client usually holds multiple input (text) fields. Xlibprovides a value type called the &lsquo;&lsquo;Input Context&rsquo;&rsquo; (IC) tomanage each individual input field. An IC can be created byspecifying XIM using XCreateIC(), and it can be destroyedusing XDestroyIC().The IC can specify the type of IM which is supported by XIMfor each input field, so each input field can handle adifferent type of IM.Most importantly information such as the committed stringsent from the IM Server to the client, is exchanged based oneach IC.Since each IC corresponds to an input field, the focusedinput field should be announced to the IM Server usingXSetICFocus(). (XUnsetICFocus() can also be used to changethe focus.)2.3. Event Handling ModelExisting input methods support either the FrontEnd method,the BackEnd method, or both. This protocol specificallysupports the BackEnd method as the default method, but alsosupports the FrontEnd method as an optional IM Serverextension.The difference between the FrontEnd and BackEnd methods isin how events are delivered to the IM Server. (Fig. 1)2.3.1. BackEnd MethodIn the BackEnd method, client window input events are alwaysdelivered to the IM library, which then passes them to theIM Server. Events are handled serially in the orderdelivered, and therefore there is no synchronization problembetween the IM library and the IM Server.Using this method, the IM library forwards all KeyPress andKeyRelease events to the IM Server (as required by the EventFlow Control model described in section 2.4. &lsquo;&lsquo;Event FlowControl&rsquo;&rsquo;), and synchronizes with the IM Server (asdescribed in section 4.16. &lsquo;&lsquo;Filtering Events&rsquo;&rsquo;).2.3.2. FrontEnd MethodIn the FrontEnd method, client window input events aredelivered by the X server directly to both the IM Server andthe IM library. Therefore this method provides much betterinteractive performance while preediting (particularly incases such as when the IM Server is running locally on theuser&rsquo;s workstation and the client application is running onanother workstation over a relatively slow network).However, the FrontEnd model may have synchronizationproblems between the key events handled in the IM Server andother events handled in the client, and these problems couldpossibly cause the loss or duplication of key events. Forthis reason, the BackEnd method is the core methodsupported, and the FrontEnd method is made available as anextension for performance purposes. (Refer to Appendix A formore information.) 1
<a name="1. Introduction1.1. ScopeThe internationalization in the X Window System Version 11,Release 5 (X11R5) provides a common API which applicationdevelopers can use to create portable internationalizedprograms and to adapt them to the requirements of differentnative languages, local customs, and character stringencodings (this is called &lsquo;&lsquo;localization&rsquo;&rsquo;). As one of itsinternationalization mechanisms X11R5 has defined afunctional interface for internationalized text input,called XIM (X Input Method).When a client-server model is used with an IM (Input Method)implementation, a protocol must be established between theclient and the server. However, the protocol used tointerface Input Method Servers (IM Servers) with the InputMethod libraries (IM libraries) to which applications arelinked was not addressed in X11R5. This led applicationdevelopers to depend on vendor-specific input methods,decreased the user&rsquo;s choice of available input methods, andmade it more difficult for developers to create portableapplications. This paper describes the Input Method Protocoldeveloped for X11R6 to resolve the above problems and toaddress the requirements of existing and future inputmethods.The Input Method Protocol is independent from the transportlayer used in communication between the IM library and theIM Server. Thus, the input method protocol can be built onany inter-process communication mechanism, such as TCP/IP orthe X protocol.In addition, the protocol provides for future extensionssuch as differing input model types.1.2. BackgroundText input is much more simple for some languages thanothers. English, for instance, uses an alphabet of amanageable size, and input consists of pressing thecorresponding key on a keyboard, perhaps in combination witha shift key for capital letters or special characters.Some languages have larger alphabets, or modifiers such asaccents, which require the addition of special keycombinations in order to enter text. These input methodsmay require &lsquo;&lsquo;dead-keys&rsquo;&rsquo; or &lsquo;&lsquo;compose-keys&rsquo;&rsquo; which, whenfollowed by different combinations of key strokes, generatedifferent characters.Text input for ideographic languages is much less simple.In these languages, characters represent actual objectsrather than phonetic sounds used in pronouncing a word, andthe number of characters in these languages may continue togrow. In Japanese, for instance, most text input methodsinvolve entering characters in a phonetic alphabet, afterwhich the input method searches a dictionary for possibleideographic equivalents (of which there may be many). Theinput method then presents the candidate characters for theuser to choose from.In Japanese, either Kana (phonetic symbols) or Roman lettersare typed and then a region is selected for conversion toKanji. Several Kanji characters may have the same phoneticrepresentation. If that is the case with the string entered,a menu of characters is presented and the user must choosethe appropriate one. If no choice is necessary or apreference has been established, the input method does thesubstitution directly.These complicated input methods must present stateinformation (Status Area), text entry and edit space(Preedit Area), and menu/choice presentations (AuxiliaryArea). Much of the protocol between the IM library and theIM Server involves managing these IM areas. Because of thesize and complexity of these input methods, and because ofhow widely they vary from one language or locale to another,they are usually implemented as separate processes which canserve many client processes on the same computer or network.1.3. Input Method StylesX11 internationalization support includes the following fourtypes of input method:- on-the-spot: The client application is directedby the IM Server to display allpre-edit data at the site of textinsertion. The client registerscallbacks invoked by the inputmethod during pre-editing.- off-the-spot: The client application providesdisplay windows for the pre-editdata to the input method whichdisplays into them directly.- over-the-spot: The input method displays pre-editdata in a window which it brings updirectly over the text insertionposition.- root-window: The input method displays allpre-edit data in a separate area ofthe screen in a window specific tothe input method.Client applications must choose from the available inputmethods supported by the IM Server and provide the displayareas and callbacks required by the input method.2. Architecture2.1. Implementation ModelWithin the X Window System environment, the following twotypical architectural models can be used as an inputmethod&rsquo;s implementation model.- Client/Server model:A separate process, the IM Server,processes input and handlespreediting, converting, andcommitting. The IM library withinthe application, acting as clientto the IM Server, simply receivesthe committed string from the IMServer.- Library model: All input is handled by the IMlibrary within the application.The event process is closed withinthe IM library and a separate IMServer process may not be required.Most languages which need complex preediting, such as Asianlanguages, are implemented using the Client/Server IM model.Other languages which need only dead key or compose keyprocessing, such as European languages, are implementedusing the Library model.In this paper, we discuss mainly the Client/Server IM modeland the protocol used in communication between the IMlibrary (client) and the IM Server.2.2. Structure of IMWhen the client connects or disconnects to the IM Server, anopen or close operation occurs between the client and the IMServer.The IM can be specified at the time of XOpenIM() by settingthe locale of the client and a locale modifier. Since the IMremembers the locale at the time of creation XOpenIM() canbe called multiple times (with the setting for the localeand the locale modifier changed) to support multiplelanguages.In addition, the supported IM type can be obtained usingXGetIMValues().The client usually holds multiple input (text) fields. Xlibprovides a value type called the &lsquo;&lsquo;Input Context&rsquo;&rsquo; (IC) tomanage each individual input field. An IC can be created byspecifying XIM using XCreateIC(), and it can be destroyedusing XDestroyIC().The IC can specify the type of IM which is supported by XIMfor each input field, so each input field can handle adifferent type of IM.Most importantly information such as the committed stringsent from the IM Server to the client, is exchanged based oneach IC.Since each IC corresponds to an input field, the focusedinput field should be announced to the IM Server usingXSetICFocus(). (XUnsetICFocus() can also be used to changethe focus.)2.3. Event Handling ModelExisting input methods support either the FrontEnd method,the BackEnd method, or both. This protocol specificallysupports the BackEnd method as the default method, but alsosupports the FrontEnd method as an optional IM Serverextension.The difference between the FrontEnd and BackEnd methods isin how events are delivered to the IM Server. (Fig. 1)2.3.1. BackEnd MethodIn the BackEnd method, client window input events are alwaysdelivered to the IM library, which then passes them to theIM Server. Events are handled serially in the orderdelivered, and therefore there is no synchronization problembetween the IM library and the IM Server.Using this method, the IM library forwards all KeyPress andKeyRelease events to the IM Server (as required by the EventFlow Control model described in section 2.4. &lsquo;&lsquo;Event FlowControl&rsquo;&rsquo;), and synchronizes with the IM Server (asdescribed in section 4.16. &lsquo;&lsquo;Filtering Events&rsquo;&rsquo;).2.3.2. FrontEnd MethodIn the FrontEnd method, client window input events aredelivered by the X server directly to both the IM Server andthe IM library. Therefore this method provides much betterinteractive performance while preediting (particularly incases such as when the IM Server is running locally on theuser&rsquo;s workstation and the client application is running onanother workstation over a relatively slow network).However, the FrontEnd model may have synchronizationproblems between the key events handled in the IM Server andother events handled in the client, and these problems couldpossibly cause the loss or duplication of key events. Forthis reason, the BackEnd method is the core methodsupported, and the FrontEnd method is made available as anextension for performance purposes. (Refer to Appendix A formore information.) 1"></a>
</h2>


<p style="margin-top: 1em"><b>X Input Method Protocol
libX11 1.3.2</b></p>

<p style="margin-top: 1em">... 0.05 6.513 4.737 10.45 ...
0.000i 3.937i 4.687i 0.000i</p>


<p align="center" style="margin-top: 1em"><img src=".1.png" alt="Image .1.png"></p>

<p align="center" style="margin-top: 1em">Fig.1 The Flow of
Events</p>

<h3>2.4. Event Flow ControlThis protocol supports two event flow models forcommunication between the IM library and the IM Server(Static and Dynamic).Static Event Flow requires that input events always be sentto the IM Server from the client.Dynamic Event Flow, however, requires only that those inputevents which need to be processed (converted) be sent to theIM Server from the client.For instance, in the case of inputing a combination of ASCIIcharacters and Chinese characters, ASCII characters do notneed to be processed in the IM Server, so their key eventsdo not have to be sent to the IM Server. On the other hand,key events necessary for composing Chinese characters mustbe sent to the IM Server.Thus, by adopting the Dynamic Event Flow, the number ofrequests among the X Server, the client, and the IM Serveris significantly reduced, and the number of context switchesis also reduced, resulting in improved performance. The IMServer can send XIM_REGISTER_TRIGGERKEYS message in order toswitch the event flow in the Dynamic Event Flow.The protocol for this process is described in section 4.5.&lsquo;&lsquo;Event Flow Control&rsquo;&rsquo;.3. Default Preconnection ConventionIM Servers are strongly encouraged to register theirsymbolic names as the ATOM names into the IM Serverdirectory property, XIM_SERVERS, on the root window of thescreen_number 0. This property can contain a list of ATOMs,and the each ATOM represents each possible IM Server. IMServer names are restricted to POSIX Portable FilenameCharacter Set. To discover if the IM Server is active, seeif there is an owner for the selection with that atom name.To learn the address of that IM Server, convert theselection target TRANSPORT, which will return a string formof the transport address(es). To learn the supportedlocales of that IM Server, convert the selection targetLOCALES, which will return a set of names of the supportedlocales in the syntax X/Open defines.The basic semantics to determine the IM Server if there aremultiple ATOMs are found in XIM_SERVERS property, is firstfit if the IM Server name is not given as a X modifier&rsquo;scategory im.The address information retrievable from the TRANSPORTtarget is a transport-specific name. The preregisteredformats for transport-specific names are listed in AppendixB. Additional transport-specific names may be registeredwith X Consortium.For environments that lack X connections, or for IM Serverswhich do not use the X Window System, the preconnectionconvention with IM Server may be given outside the X Windowsystem (e.g. using a Name Service).4. ProtocolThe protocol described below uses the bi-directionalsynchronous/asynchronous request/reply/error model and isspecified using the same conventions outlined in Section 2of the core X Window System protocol [1]:4.1. Basic Requests Packet FormatThis section describes the requests that may be exchangedbetween the client and the IM Server.The basic request packet header format is as follows.major-opcode: CARD8minor-opcode: CARD8length: CARD16The MAJOR-OPCODE specifies which core request or extensionpackage this packet represents. If the MAJOR-OPCODEcorresponds to a core request, the MINOR-OPCODE contains 8bits of request-specific data. (If the MINOR-OPCODE is notused, it is 0.) Otherwise, the MAJOR-OPCODE and theMINOR-OPCODE are specified by XIM_QUERY_EXTENSION message.(Refer to 4.7. Query the supported extension protocol list.)The LENGTH field specifies the number of 4 bytes elementsfollowing the header. If no additional data is followed bythe header, the LENGTH field will be 0.4.2. Data TypesThe following data types are used in the core X IM Serverprotocol:BITMASK16CARD16BITMASK32CARD32PADDING FORMATWhere N is some expression, and Pad(N) is the number of bytes needed to round N up to amultiple of four.Pad(N) = (4 - (N mod 4)) mod 4LPCE1 A character from the4 X Portable Character Set in Latin PortableCharacter Encoding2
<a name="2.4. Event Flow ControlThis protocol supports two event flow models forcommunication between the IM library and the IM Server(Static and Dynamic).Static Event Flow requires that input events always be sentto the IM Server from the client.Dynamic Event Flow, however, requires only that those inputevents which need to be processed (converted) be sent to theIM Server from the client.For instance, in the case of inputing a combination of ASCIIcharacters and Chinese characters, ASCII characters do notneed to be processed in the IM Server, so their key eventsdo not have to be sent to the IM Server. On the other hand,key events necessary for composing Chinese characters mustbe sent to the IM Server.Thus, by adopting the Dynamic Event Flow, the number ofrequests among the X Server, the client, and the IM Serveris significantly reduced, and the number of context switchesis also reduced, resulting in improved performance. The IMServer can send XIM_REGISTER_TRIGGERKEYS message in order toswitch the event flow in the Dynamic Event Flow.The protocol for this process is described in section 4.5.&lsquo;&lsquo;Event Flow Control&rsquo;&rsquo;.3. Default Preconnection ConventionIM Servers are strongly encouraged to register theirsymbolic names as the ATOM names into the IM Serverdirectory property, XIM_SERVERS, on the root window of thescreen_number 0. This property can contain a list of ATOMs,and the each ATOM represents each possible IM Server. IMServer names are restricted to POSIX Portable FilenameCharacter Set. To discover if the IM Server is active, seeif there is an owner for the selection with that atom name.To learn the address of that IM Server, convert theselection target TRANSPORT, which will return a string formof the transport address(es). To learn the supportedlocales of that IM Server, convert the selection targetLOCALES, which will return a set of names of the supportedlocales in the syntax X/Open defines.The basic semantics to determine the IM Server if there aremultiple ATOMs are found in XIM_SERVERS property, is firstfit if the IM Server name is not given as a X modifier&rsquo;scategory im.The address information retrievable from the TRANSPORTtarget is a transport-specific name. The preregisteredformats for transport-specific names are listed in AppendixB. Additional transport-specific names may be registeredwith X Consortium.For environments that lack X connections, or for IM Serverswhich do not use the X Window System, the preconnectionconvention with IM Server may be given outside the X Windowsystem (e.g. using a Name Service).4. ProtocolThe protocol described below uses the bi-directionalsynchronous/asynchronous request/reply/error model and isspecified using the same conventions outlined in Section 2of the core X Window System protocol [1]:4.1. Basic Requests Packet FormatThis section describes the requests that may be exchangedbetween the client and the IM Server.The basic request packet header format is as follows.major-opcode: CARD8minor-opcode: CARD8length: CARD16The MAJOR-OPCODE specifies which core request or extensionpackage this packet represents. If the MAJOR-OPCODEcorresponds to a core request, the MINOR-OPCODE contains 8bits of request-specific data. (If the MINOR-OPCODE is notused, it is 0.) Otherwise, the MAJOR-OPCODE and theMINOR-OPCODE are specified by XIM_QUERY_EXTENSION message.(Refer to 4.7. Query the supported extension protocol list.)The LENGTH field specifies the number of 4 bytes elementsfollowing the header. If no additional data is followed bythe header, the LENGTH field will be 0.4.2. Data TypesThe following data types are used in the core X IM Serverprotocol:BITMASK16CARD16BITMASK32CARD32PADDING FORMATWhere N is some expression, and Pad(N) is the number of bytes needed to round N up to amultiple of four.Pad(N) = (4 - (N mod 4)) mod 4LPCE1 A character from the4 X Portable Character Set in Latin PortableCharacter Encoding2"></a>
</h3>


<p style="margin-top: 1em"><b>X Input Method Protocol
libX11 1.3.2</b></p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="5%">


<p>STRING</p></td>
<td width="8%">


<p>2</p></td>
<td width="37%">


<p>n</p></td>
<td width="50%">


<p>length of string in bytes</p></td></tr>
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">


<p>n</p></td>
<td width="37%">


<p>LISTofLPCE</p></td>
<td width="50%">


<p>string</p></td></tr>
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">


<p>p</p></td>
<td width="37%">
</td>
<td width="50%">


<p>unused, p=Pad(2+n)</p></td></tr>
<tr valign="top" align="left">
<td width="5%">


<p>STR</p></td>
<td width="8%">


<p>1</p></td>
<td width="37%">


<p>n</p></td>
<td width="50%">


<p>length of name in bytes</p></td></tr>
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">


<p>n</p></td>
<td width="37%">


<p>STRING8</p></td>
<td width="50%">


<p>name</p></td></tr>
<tr valign="top" align="left">
<td width="5%">


<p>XIMATTR</p></td>
<td width="8%">


<p>2</p></td>
<td width="37%">


<p>CARD16</p></td>
<td width="50%">


<p>attribute ID (*1)</p></td></tr>
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">


<p>2</p></td>
<td width="37%">


<p>CARD16</p></td>
<td width="50%">


<p>type of the value (*2)</p></td></tr>
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">


<p>2</p></td>
<td width="37%">


<p>n</p></td>
<td width="50%">


<p>length of im-attribute</p></td></tr>
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">


<p>n</p></td>
<td width="37%">


<p>STRING8</p></td>
<td width="50%">


<p>im-attribute</p></td></tr>
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">


<p>p</p></td>
<td width="37%">
</td>
<td width="50%">


<p>unused, p = Pad(2+n)</p></td></tr>
</table>

<p style="margin-top: 1em">The im-attribute argument
specifies XIM values such as XNQueryInputStyle.</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="5%">


<p>XICATTR</p></td>
<td width="8%">


<p>2</p></td>
<td width="37%">


<p>CARD16</p></td>
<td width="50%">


<p>attribute ID (*1)</p></td></tr>
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">


<p>2</p></td>
<td width="37%">


<p>CARD16</p></td>
<td width="50%">


<p>type of the value (*2)</p></td></tr>
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">


<p>2</p></td>
<td width="37%">


<p>n</p></td>
<td width="50%">


<p>length of ic-attribute</p></td></tr>
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">


<p>n</p></td>
<td width="37%">


<p>STRING8</p></td>
<td width="50%">


<p>ic-attribute</p></td></tr>
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">


<p>p</p></td>
<td width="37%">
</td>
<td width="50%">


<p>unused, p = Pad(2+n)</p></td></tr>
</table>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="13%">


<p style="margin-top: 1em">(*1)</p></td>
<td width="87%">


<p style="margin-top: 1em">XIMATTR and XICATTR are used
during the setup stage and XIMATTRIBUTE and XICATTRIBUTE are
used after each attribute ID has been recognized by the IM
Server and the IM library.</p></td></tr>
<tr valign="top" align="left">
<td width="13%">


<p>(*2)</p></td>
<td width="87%">


<p>The value types are defined as follows:</p></td></tr>
</table>


<p align="center"><img src=".2.png" alt="Image .2.png"></p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="10%">


<p style="margin-top: 1em">(*3)</p></td>
<td width="3%"></td>
<td width="87%">


<p style="margin-top: 1em">The IC value for the separator
of NestedList is defined as follows,</p></td></tr>
<tr valign="top" align="left">
<td width="10%"></td>
<td width="3%"></td>
<td width="87%">


<p>#define XNSeparatorofNestedList
&lsquo;&lsquo;separatorofNestedList&rsquo;&rsquo;</p> </td></tr>
</table>

<p style="margin-left:30%;">, which is registered in X
Consortium and cannot be used for any other purpose.</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="10%">


<p style="margin-top: 1em">(*4)</p></td>
<td width="3%"></td>
<td width="22%">


<p style="margin-top: 1em">LISTofFOO</p></td>
<td width="65%">
</td></tr>
</table>

<p style="margin-left:40%;">A Type name of the form LISTof
FOO means a counted list of elements of type FOO. The size
of the length field may vary (it is not necessarily the same
size as a FOO), and in some cases, it may be implicit.</p>

<p style="margin-top: 1em">XIMTRIGGERKEY</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">


<p>4</p></td>
<td width="37%">


<p>CARD32</p></td>
<td width="50%">


<p>keysym</p></td></tr>
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">


<p>4</p></td>
<td width="37%">


<p>CARD32</p></td>
<td width="50%">


<p>modifier</p></td></tr>
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">


<p>4</p></td>
<td width="37%">


<p>CARD32</p></td>
<td width="50%">


<p>modifier mask</p></td></tr>
</table>

<p style="margin-top: 1em">ENCODINGINFO</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">


<p>2</p></td>
<td width="37%">


<p>n</p></td>
<td width="50%">


<p>length of encoding info</p></td></tr>
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">


<p>n</p></td>
<td width="37%">


<p>STRING8</p></td>
<td width="50%">


<p>encoding info</p></td></tr>
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">


<p>p</p></td>
<td width="37%">
</td>
<td width="50%">


<p>unused, p=Pad(2+n)</p></td></tr>
</table>

<p style="margin-top: 1em">EXT</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">


<p>1</p></td>
<td width="37%">


<p>CARD8</p></td>
<td width="50%">


<p>extension major-opcode</p></td></tr>
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">


<p>1</p></td>
<td width="37%">


<p>CARD8</p></td>
<td width="50%">


<p>extension minor-opcode</p></td></tr>
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">


<p>2</p></td>
<td width="37%">


<p>n</p></td>
<td width="50%">


<p>length of extension name</p></td></tr>
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">


<p>n</p></td>
<td width="37%">


<p>STRING8</p></td>
<td width="50%">


<p>extension name</p></td></tr>
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">


<p>p</p></td>
<td width="37%">
</td>
<td width="50%">


<p>unused, p = Pad(n)</p></td></tr>
</table>

<p style="margin-top: 1em">XIMATTRIBUTE</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">


<p>2</p></td>
<td width="37%">


<p>CARD16</p></td>
<td width="50%">


<p>attribute ID</p></td></tr>
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">


<p>2</p></td>
<td width="37%">


<p>n</p></td>
<td width="50%">


<p>value length</p></td></tr>
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">


<p>n</p></td>
<td width="37%">
</td>
<td width="50%">


<p>value</p></td></tr>
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">


<p>p</p></td>
<td width="37%">
</td>
<td width="50%">


<p>unused, p = Pad(n)</p></td></tr>
</table>

<p style="margin-top: 1em">XICATTRIBUTE</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">


<p>2</p></td>
<td width="37%">


<p>CARD16</p></td>
<td width="50%">


<p>attribute ID</p></td></tr>
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">


<p>2</p></td>
<td width="37%">


<p>n</p></td>
<td width="50%">


<p>value length</p></td></tr>
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">


<p>n</p></td>
<td width="37%">
</td>
<td width="50%">


<p>value</p></td></tr>
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">


<p>p</p></td>
<td width="37%">
</td>
<td width="50%">


<p>unused, p = Pad(n)</p></td></tr>
</table>

<p style="margin-top: 1em"><b>3</b></p>

<p style="margin-top: 1em"><b>X Input Method Protocol
libX11 1.3.2</b></p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="5%">


<p>XIMSTRCONVTEXT</p></td>
<td width="8%">


<p>2</p></td>
<td width="62%">


<p>CARD16</p></td>
<td width="25%">


<p>XIMStringConversionFeedback</p></td></tr>
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">
</td>
<td width="62%">


<p>#x0000001</p></td>
<td width="25%">


<p>XIMStringConversionLeftEdge</p></td></tr>
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">
</td>
<td width="62%">


<p>#x0000002</p></td>
<td width="25%">


<p>XIMStringConversionRightEdge</p></td></tr>
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">
</td>
<td width="62%">


<p>#x0000004</p></td>
<td width="25%">


<p>XIMStringConversionTopEdge</p></td></tr>
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">
</td>
<td width="62%">


<p>#x0000008</p></td>
<td width="25%">


<p>XIMStringConversionBottomEdge</p></td></tr>
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">
</td>
<td width="62%">


<p>#x0000010</p></td>
<td width="25%">


<p>XIMStringConversionConvealed</p></td></tr>
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">
</td>
<td width="62%">


<p>#x0000020</p></td>
<td width="25%">


<p>XIMStringConversionWrapped</p></td></tr>
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">


<p>2</p></td>
<td width="62%">


<p>n</p></td>
<td width="25%">


<p>byte length of the retrieved string</p></td></tr>
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">


<p>n</p></td>
<td width="62%">


<p>STRING8</p></td>
<td width="25%">


<p>retrieved string</p></td></tr>
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">


<p>p</p></td>
<td width="62%">
</td>
<td width="25%">


<p>unused, p = Pad(n)</p></td></tr>
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">


<p>2</p></td>
<td width="62%">


<p>m</p></td>
<td width="25%">


<p>byte length of feedback array</p></td></tr>
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">


<p>2</p></td>
<td width="62%">
</td>
<td width="25%">


<p>unused</p></td></tr>
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">


<p>m</p></td>
<td width="62%">


<p>LISTofXIMSTRCONVFEEDBACK</p></td>
<td width="25%">


<p>feedback array(*1)</p></td></tr>
</table>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="10%">


<p style="margin-top: 1em">(*1)</p></td>
<td width="3%"></td>
<td width="87%">


<p style="margin-top: 1em">This field is reserved for
future use.</p></td></tr>
</table>

<p style="margin-top: 1em">XIMFEEDBACK</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">


<p>4</p></td>
<td width="37%">


<p>CARD32</p></td>
<td width="50%">


<p>XIMFeedback</p></td></tr>
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">
</td>
<td width="37%">


<p>#x000001</p></td>
<td width="50%">


<p>XIMReverse</p></td></tr>
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">
</td>
<td width="37%">


<p>#x000002</p></td>
<td width="50%">


<p>XIMUnderline</p></td></tr>
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">
</td>
<td width="37%">


<p>#x000004</p></td>
<td width="50%">


<p>XIMHighlight</p></td></tr>
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">
</td>
<td width="37%">


<p>#x000008</p></td>
<td width="50%">


<p>XIMPrimary</p></td></tr>
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">
</td>
<td width="37%">


<p>#x000010</p></td>
<td width="50%">


<p>XIMSecondary</p></td></tr>
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">
</td>
<td width="37%">


<p>#x000020</p></td>
<td width="50%">


<p>XIMTertiary</p></td></tr>
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">
</td>
<td width="37%">


<p>#x000040</p></td>
<td width="50%">


<p>XIMVisibleToForward</p></td></tr>
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">
</td>
<td width="37%">


<p>#x000080</p></td>
<td width="50%">


<p>XIMVisibleToBackward</p></td></tr>
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">
</td>
<td width="37%">


<p>#x000100</p></td>
<td width="50%">


<p>XIMVisibleCenter</p></td></tr>
</table>

<p style="margin-top: 1em">XIMHOTKEYSTATE</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">


<p>4</p></td>
<td width="37%">


<p>CARD32</p></td>
<td width="50%">


<p>XIMHotKeyState</p></td></tr>
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">
</td>
<td width="37%">


<p>#x0000001</p></td>
<td width="50%">


<p>XIMHotKeyStateON</p></td></tr>
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">
</td>
<td width="37%">


<p>#x0000002</p></td>
<td width="50%">


<p>XIMHotKeyStateOFF</p></td></tr>
</table>

<p style="margin-top: 1em">XIMPREEDITSTATE</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">


<p>4</p></td>
<td width="37%">


<p>CARD32</p></td>
<td width="50%">


<p>XIMPreeditState</p></td></tr>
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">
</td>
<td width="37%">


<p>#x0000001</p></td>
<td width="50%">


<p>XIMPreeditEnable</p></td></tr>
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">
</td>
<td width="37%">


<p>#x0000002</p></td>
<td width="50%">


<p>XIMPreeditDisable</p></td></tr>
</table>

<p style="margin-top: 1em">XIMRESETSTATE</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">


<p>4</p></td>
<td width="37%">


<p>CARD32</p></td>
<td width="50%">


<p>XIMResetState</p></td></tr>
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">
</td>
<td width="37%">


<p>#x0000001</p></td>
<td width="50%">


<p>XIMInitialState</p></td></tr>
<tr valign="top" align="left">
<td width="5%"></td>
<td width="8%">
</td>
<td width="37%">


<p>#x0000002</p></td>
<td width="50%">


<p>XIMPreserveState</p></td></tr>
</table>

<h3>4.3. Error NotificationBoth the IM Server and the IM library return XIM_ERRORmessages instead of the corresponding reply messages if anyerrors occur during data processing.At most one error is generated per request. If more than oneerror condition is encountered in processing a request, thechoice of which error is returned isimplementation-dependent.(*1) Before an IM is created, both Input-Method-ID andInput-Context-ID are invalid. Before an IC iscreated, only Input-Method-ID is valid. Afterthat, both of Input-Method-ID and Input-Context-IDare valid.(*2) Unspecific error, for example &lsquo;&lsquo;language enginedied&rsquo;&rsquo;(*3) This field is reserved for future use.(*4) Vendor defined detail error message4.4. Connection EstablishmentXIM_CONNECT message requests to establish a connection overa mutually-understood virtual stream.(*1) Specify the version of IM Protocol that the clientsupports.A client must send XIM_CONNECT message as the first messageon the connection. The list specifies the names ofauthentication protocols the sending IM Server is willing toperform. (If the client need not authenticate, the list maybe omited.)XIM_AUTH_REQUIRED message is used to send the authenticationprotocol name and protocol-specific data.The auth-protocol is specified by an index into the list ofnames given in the XIM_CONNECT or XIM_AUTH_SETUP message.Any protocol-specific data that might be required is alsosent.The IM library sends XIM_AUTH_REPLY message as the reply toXIM_AUTH_REQUIRED message, if the IM Server isauthenticated.The auth data is specific to the authentication protocol inuse.XIM_AUTH_NEXT message requests to send more auth data.The auth data is specific to the authentication protocol inuse.The IM Server sends XIM_AUTH_SETUP message to authenticatethe client.The list specifies the names of authentication protocols theclient is willing to perform.XIM_AUTH_NG message requests to give up the connection.The IM Server sends XIM_CONNECT_REPLY message as the replyto XIM_CONNECT or XIM_AUTH_REQUIRED message.(*1) Specify the version of IM Protocol that the IMServer supports. This document specifies majorversion one, minor version zero.Here are the state diagrams for the client and the IMServer.State transitions for the clientinit_status:Use authorization function &rarr; client_askNot use authorization function &rarr; client_no_checkstart:Send XIM_CONNECTIf client_ask &rarr; client_wait1If client_no_check,client-auth-protocol-names may be omited &rarr;client_wait2client_wait1:Receive XIM_AUTH_REQUIRED &rarr; client_checkReceive &lt;other&gt; &rarr; client_NGclient_check:If no more auth needed, send XIM_AUTH_REPLY &rarr;client_wait2If good auth data, send XIM_AUTH_NEXT &rarr;client_wait1If bad auth data, send XIM_AUTH_NG &rarr; give up onthis protocolclient_wait2:Receive XIM_CONNECT_REPLY &rarr; connectReceive XIM_AUTH_SETUP &rarr; client_moreReceive XIM_AUTH_NEXT &rarr; client_moreReceive XIM_AUTH_NG &rarr; give up on this protocolReceive &lt;other&gt; &rarr; client_NGclient_more:Send XIM_AUTH_REQUIRED &rarr; client_wait2client_NG:Send XIM_AUTH_NG &rarr; give up on this protocolState transitions for the IM Serverinit-status:Use authorization function &rarr; server_askNot use authorization function &rarr; server_no_checkstart:Receive XIM_CONNECT &rarr; start2Receive &lt;other&gt; &rarr; server_NGstart2:If client_ask, send XIM_AUTH_REQUIRED &rarr;server_wait1If client_no_check and server_ask, sendXIM_AUTH_SETUP &rarr; server_wait2If client_no_check and server_no_check, sendXIM_CONNECT_REPLY &rarr; connectserver_wait1:Receive XIM_AUTH_REPLY &rarr; server2Receive XIM_AUTH_NEXT &rarr; server_moreReceive &lt;other&gt; &rarr; server_NGserver_moreSend XIM_AUTH_REQUIRED &rarr; server_wait1server2If server_ask, send XIM_AUTH_SETUP &rarr; server_wait2If server_no_check, send XIM_CONNECT_REPLY &rarr;connectserver_wait2Receive XIM_AUTH_REQUIRED &rarr; server_checkReceive &lt;other&gt; &rarr; server_NGserver_checkIf no more auth data, send XIM_CONNECT_REPLY &rarr;connectIf bad auth data, send XIM_AUTH_NG &rarr; give up onthis protocolIf good auth data, send XIM_AUTH_NEXT &rarr;server_wait2server_NGSend XIM_AUTH_NG &rarr; give up on this protocolXIM_DISCONNECT message requests to shutdown the connectionover a mutually-understood virtual stream.XIM_DISCONNECT is a synchronous request. The IM libraryshould wait until it receives either an XIM_DISCONNECT_REPLYpacket or an XIM_ERROR packet.XIM_OPEN requests to establish a logical connection betweenthe IM library and the IM Server.XIM_OPEN is a synchronous request. The IM library shouldwait until receiving either an XIM_OPEN_REPLY packet or anXIM_ERROR packet.XIM_OPEN_REPLY message returns all supported IM and ICattributes in LISTofXIMATTR and LISTofXICATTR. These IM andIC attribute IDs are used to reduce the amount of data whichmust be transferred via the network. In addition, thisindicates to the IM library what kinds of IM/IC attributescan be used in this session, and what types of data will beexchanged. This allows the IM Server provider andapplication writer to support IM system enhancements withnew IM/IC attributes, without modifying Xlib. The IC valuefor the separator of NestedList must be included in theLISTofXICATTR.XIM_CLOSE message requests to shutdown the logicalconnection between the IM library and the IM Server.XIM_CLOSE is a synchronous request. The IM library shouldwait until receiving either an XIM_CLOSE_REPLY packet or anXIM_ERROR packet.4.5. Event Flow ControlAn IM Server must send XIM_SET_EVENT_MASK message to the IMlibrary in order for events to be forwarded to the IMServer, since the IM library initially doesn&rsquo;t forward anyevents to the IM Server. In the protocol, the IM Server willspecify masks of X events to be forwarded and which need tobe synchronized by the IM library.(*1) Specify all the events to be forwarded to the IMServer by the IM library.(*2) Specify the events to be forwarded withsynchronous flag on by the IM library.XIM_SET_EVENT_MASK is an asynchronous request. The eventmasks are valid immediately after they are set until changedby another XIM_SET_EVENT_MASK message. If input-context-IDis set to zero, the default value of the input-method-IDwill be changed to the event masks specified in the request.That value will be used for the IC&rsquo;s which have noindividual values.Using the Dynamic Event Flow model, an IM Server sendsXIM_REGISTER_TRIGGERKEYS message to the IM library beforesending XIM_OPEN_REPLY message. Or the IM library maysuppose that the IM Server uses the Static Event Flow model.XIM_REGISTER_TRIGGERKEYS is an asynchronous request. The IMServer notifys the IM library of on-keys and off-keys listswith this message.The IM library notifys the IM Server with XIM_TRIGGER_NOTIFYmessage that a key event matching either on-keys or off-keyshas been occurred.(*1) Specify the events currently selected by the IMlibrary with XSelectInput.XIM_TRIGGER_NOTIFY is a synchronous request. The IM libraryshould wait until receiving either anXIM_TRIGGER_NOTIFY_REPLY packet or an XIM_ERROR packet.4.6. Encoding NegotiationXIM_ENCODING_NEGOTIATION message requests to decide whichencoding to be sent across the wire. When the negotiationfails, the fallback default encoding is Portable CharacterEncoding.The IM Server must choose one encoding from the list sent bythe IM library. If index of the encording determined is -1to indicate that the negotiation is failed, the fallbackdefault encoding is used. The message must be issued aftersending XIM_OPEN message via XOpenIM(). The name ofencoding may be registered with X Consortium.XIM_ENCODING_NEGOTIATION is a synchronous request. The IMlibrary should wait until receiving either anXIM_ENCODING_NEGOTIATION_REPLY packet or an XIM_ERRORpacket.4.7. Query the supported extension protocol listXIM_QUERY_EXTENSION message requests to query the IMextensions supported by the IM Server to which the client isbeing connected.An example of a supported extension is FrontEnd. Themessage must be issued after sending XIM_OPEN message viaXOpenIM().If n is 0, the IM library queries the IM Server for allextensions.If n is not 0, the IM library queries whether the IM Serversupports the contents specified in the list.If a client uses an extension request without previouslyhaving issued a XIM_QUERY_EXTENSION message for thatextension, the IM Server responds with a BadProtocol error.If the IM Server encounters a request with an unknownMAJOR-OPCODE or MINOR-OPCODE, it responds with a BadProtocolerror.XIM_QUERY_EXTENSION is a synchronous request. The IMlibrary should wait until receiving either anXIM_QUERY_EXTENSION_REPLY packet or an XIM_ERROR packet.XIM_QUERY_EXTENSION_REPLY message returns the list ofextensions supported by both the IM library and the IMServer. If the list passed in XIM_QUERY_EXTENSION message isNULL, the IM Server returns the full list of extensionssupported by the IM Server. If the list is not NULL, the IMServer returns the extensions in the list that are supportedby the IM Server.A zero-length string is not a valid extension name. The IMlibrary should disregard any zero-length strings that arereturned in the extension list. The IM library does not usethe requests which are not supported by the IM Server.4.8. Setting IM ValuesXIM_SET_IM_VALUES requests to set attributes to the IM.The im-attributes in XIM_SET_IM_VALUES message are specifiedas a LISTofXIMATTRIBUTE, specifying the attributes to beset. Attributes other than the ones returned byXIM_OPEN_REPLY message should not be specified.XIM_SET_IM_VALUES is a synchronous request. The IM libraryshould wait until receiving either anXIM_SET_IM_VALUES_REPLY packet or an XIM_ERROR packet,because it must receive the error attribute if XIM_ERRORmessage is returned.XIM_SET_IM_VALUES_REPLY message returns the input-method-IDto distinguish replies from multiple IMs.4.9. Getting IM ValuesXIM_GET_IM_VALUES requests to query IM values supported bythe IM Server currently being connected.XIM_GET_IM_VALUES is a synchronous request. The IM libraryshould wait until it receives either anXIM_GET_IM_VALUES_REPLY packet or an XIM_ERROR packet.The IM Server returns IM values with XIM_GET_IM_VALUES_REPLYmessage. The order of the returned im-attribute valuescorresponds directly to that of the list passed with theXIM_GET_IM_VALUES message.4.10. Creating an ICXIM_CREATE_IC message requests to create an IC.The input-context-id is specified by the IM Server toidentify the client (IC). (It is not specified by theclient in XIM_CREATE_IC message.), and it should not be setto zero.XIM_CREATE_IC is a synchronous request which returns theinput-context-ID. The IM library should wait until itreceives either an XIM_CREATE_IC_REPLY packet or anXIM_ERROR packet.4.11. Destroying the ICXIM_DESTROY_IC message requests to destroy the IC.XIM_DESTROY_IC is a synchronous request. The IM libraryshould not free its resources until it receives anXIM_DESTROY_IC_REPLY message because XIM_DESTROY_IC messagemay result in Callback packets such as XIM_PREEDIT_DRAW andXIM_PREEDIT_DONE.4.12. Setting IC ValuesXIM_SET_IC_VALUES messages requests to set attributes to theIC.The ic-attributes in XIM_SET_IC_VALUES message are specifiedas a LISTofXICATTRIBUTE, specifying the attributes to beset. Attributes other than the ones returned byXIM_OPEN_REPLY message should not be specified.XIM_SET_IC_VALUES is a synchronous request. The IM libraryshould wait until receiving either anXIM_SET_IC_VALUES_REPLY packet or an XIM_ERROR packet,because it must receive the error attribute if XIM_ERRORmessage is returned.4.13. Getting IC ValuesXIM_GET_IC_VALUES message requests to query IC valuessupported by the IM Server currently being connected.In LISTofCARD16, the appearance of the ic-attribute-id forthe separator of NestedList shows the end of the headingnested list.XIM_GET_IC_VALUES is a synchronous request and returns eachattribute with its values to show the correspondence. TheIM library should wait until receiving either anXIM_GET_IC_VALUES_REPLY packet or an XIM_ERROR packet.4.14. Setting IC FocusXIM_SET_IC_FOCUS message requests to set the focus to theIC.XIM_SET_IC_FOCUS is an asynchronous request.4.15. Unsetting IC FocusXIM_UNSET_IC_FOCUS message requests to unset the focus tothe focused IC.XIM_UNSET_IC_FOCUS is an asynchronous request.4.16. Filtering EventsEvent filtering is mainly provided for BackEnd method toallow input method to capture X events transparently toclients.X Events are forwarded by XIM_FORWARD_EVENT message. Thismessage can be operated both synchronously andasynchronously. If the requester sets the synchronous flag,the receiver must send XIM_SYNC_REPLY message back to therequester when all the data processing is done.Protocol flow of BackEnd modelWith BackEnd method, the protocol flow can be classifiedinto two methods in terms of synchronization, depending onthe synchronous-eventmask of XIM_SET_EVENT_MASK message.One can be called on-demand-synchronous method and anothercan be called as full-synchronous method.In on-demand-synchronous method, the IM library alwaysreceives XIM_FORWARD_EVENT or XIM_COMMIT message as asynchronous request. Also, the IM Server needs tosynchronously process the correspondent reply from the IMlibrary and the following XIM_FORWARD_EVENT message sentfrom the IM library when any of the event causes the IMServer to send XIM_FORWARD_EVENT or XIM_COMMIT message tothe IM library, so that the input service is consistent. Ifthe IM library gets the control back from the applicationafter receiving the synchronous request, the IM libraryreplies for the synchronous request before processing any ofthe events. In this time, the IM Server blocksXIM_FORWARD_EVENT message which is sent by the IM library,and handles it after receiving the reply. However, the IMServer handles the other protocols at any time.In full-synchronous method, the IM library always sendsXIM_FORWARD_EVENT message to the IM Server as a synchronousrequest. Therefore, the reply to it from the IM Server willbe put between the XIM_FORWARD_EVENT message and itsXIM_SYNC_REPLY message. In case of sendingXIM_FORWARD_EVENT or XIM_COMMIT message, the IM Servershould set the synchronous flag off. Because thesynchronization can be done by the following XIM_SYNC_REPLYmessage.Sample Protocol flow chart 1Following chart shows one of the simplest protocol flowwhich only deals with keyevents for preediting operation.... 0.425 6.888 6.3 10.296 ... 0.000i 3.408i 5.875i 0.000iFig.2 Sample Protocol FlowSample Protocol flow chart 2Following chart shows one of the complex protocol flow,which deals with multiple focus windows and button pressevent as well as keyevent, and the focus is moved by theapplication triggered by both of keyevent and button pressevent. 4
<a name="4.3. Error NotificationBoth the IM Server and the IM library return XIM_ERRORmessages instead of the corresponding reply messages if anyerrors occur during data processing.At most one error is generated per request. If more than oneerror condition is encountered in processing a request, thechoice of which error is returned isimplementation-dependent.(*1) Before an IM is created, both Input-Method-ID andInput-Context-ID are invalid. Before an IC iscreated, only Input-Method-ID is valid. Afterthat, both of Input-Method-ID and Input-Context-IDare valid.(*2) Unspecific error, for example &lsquo;&lsquo;language enginedied&rsquo;&rsquo;(*3) This field is reserved for future use.(*4) Vendor defined detail error message4.4. Connection EstablishmentXIM_CONNECT message requests to establish a connection overa mutually-understood virtual stream.(*1) Specify the version of IM Protocol that the clientsupports.A client must send XIM_CONNECT message as the first messageon the connection. The list specifies the names ofauthentication protocols the sending IM Server is willing toperform. (If the client need not authenticate, the list maybe omited.)XIM_AUTH_REQUIRED message is used to send the authenticationprotocol name and protocol-specific data.The auth-protocol is specified by an index into the list ofnames given in the XIM_CONNECT or XIM_AUTH_SETUP message.Any protocol-specific data that might be required is alsosent.The IM library sends XIM_AUTH_REPLY message as the reply toXIM_AUTH_REQUIRED message, if the IM Server isauthenticated.The auth data is specific to the authentication protocol inuse.XIM_AUTH_NEXT message requests to send more auth data.The auth data is specific to the authentication protocol inuse.The IM Server sends XIM_AUTH_SETUP message to authenticatethe client.The list specifies the names of authentication protocols theclient is willing to perform.XIM_AUTH_NG message requests to give up the connection.The IM Server sends XIM_CONNECT_REPLY message as the replyto XIM_CONNECT or XIM_AUTH_REQUIRED message.(*1) Specify the version of IM Protocol that the IMServer supports. This document specifies majorversion one, minor version zero.Here are the state diagrams for the client and the IMServer.State transitions for the clientinit_status:Use authorization function &rarr; client_askNot use authorization function &rarr; client_no_checkstart:Send XIM_CONNECTIf client_ask &rarr; client_wait1If client_no_check,client-auth-protocol-names may be omited &rarr;client_wait2client_wait1:Receive XIM_AUTH_REQUIRED &rarr; client_checkReceive &lt;other&gt; &rarr; client_NGclient_check:If no more auth needed, send XIM_AUTH_REPLY &rarr;client_wait2If good auth data, send XIM_AUTH_NEXT &rarr;client_wait1If bad auth data, send XIM_AUTH_NG &rarr; give up onthis protocolclient_wait2:Receive XIM_CONNECT_REPLY &rarr; connectReceive XIM_AUTH_SETUP &rarr; client_moreReceive XIM_AUTH_NEXT &rarr; client_moreReceive XIM_AUTH_NG &rarr; give up on this protocolReceive &lt;other&gt; &rarr; client_NGclient_more:Send XIM_AUTH_REQUIRED &rarr; client_wait2client_NG:Send XIM_AUTH_NG &rarr; give up on this protocolState transitions for the IM Serverinit-status:Use authorization function &rarr; server_askNot use authorization function &rarr; server_no_checkstart:Receive XIM_CONNECT &rarr; start2Receive &lt;other&gt; &rarr; server_NGstart2:If client_ask, send XIM_AUTH_REQUIRED &rarr;server_wait1If client_no_check and server_ask, sendXIM_AUTH_SETUP &rarr; server_wait2If client_no_check and server_no_check, sendXIM_CONNECT_REPLY &rarr; connectserver_wait1:Receive XIM_AUTH_REPLY &rarr; server2Receive XIM_AUTH_NEXT &rarr; server_moreReceive &lt;other&gt; &rarr; server_NGserver_moreSend XIM_AUTH_REQUIRED &rarr; server_wait1server2If server_ask, send XIM_AUTH_SETUP &rarr; server_wait2If server_no_check, send XIM_CONNECT_REPLY &rarr;connectserver_wait2Receive XIM_AUTH_REQUIRED &rarr; server_checkReceive &lt;other&gt; &rarr; server_NGserver_checkIf no more auth data, send XIM_CONNECT_REPLY &rarr;connectIf bad auth data, send XIM_AUTH_NG &rarr; give up onthis protocolIf good auth data, send XIM_AUTH_NEXT &rarr;server_wait2server_NGSend XIM_AUTH_NG &rarr; give up on this protocolXIM_DISCONNECT message requests to shutdown the connectionover a mutually-understood virtual stream.XIM_DISCONNECT is a synchronous request. The IM libraryshould wait until it receives either an XIM_DISCONNECT_REPLYpacket or an XIM_ERROR packet.XIM_OPEN requests to establish a logical connection betweenthe IM library and the IM Server.XIM_OPEN is a synchronous request. The IM library shouldwait until receiving either an XIM_OPEN_REPLY packet or anXIM_ERROR packet.XIM_OPEN_REPLY message returns all supported IM and ICattributes in LISTofXIMATTR and LISTofXICATTR. These IM andIC attribute IDs are used to reduce the amount of data whichmust be transferred via the network. In addition, thisindicates to the IM library what kinds of IM/IC attributescan be used in this session, and what types of data will beexchanged. This allows the IM Server provider andapplication writer to support IM system enhancements withnew IM/IC attributes, without modifying Xlib. The IC valuefor the separator of NestedList must be included in theLISTofXICATTR.XIM_CLOSE message requests to shutdown the logicalconnection between the IM library and the IM Server.XIM_CLOSE is a synchronous request. The IM library shouldwait until receiving either an XIM_CLOSE_REPLY packet or anXIM_ERROR packet.4.5. Event Flow ControlAn IM Server must send XIM_SET_EVENT_MASK message to the IMlibrary in order for events to be forwarded to the IMServer, since the IM library initially doesn&rsquo;t forward anyevents to the IM Server. In the protocol, the IM Server willspecify masks of X events to be forwarded and which need tobe synchronized by the IM library.(*1) Specify all the events to be forwarded to the IMServer by the IM library.(*2) Specify the events to be forwarded withsynchronous flag on by the IM library.XIM_SET_EVENT_MASK is an asynchronous request. The eventmasks are valid immediately after they are set until changedby another XIM_SET_EVENT_MASK message. If input-context-IDis set to zero, the default value of the input-method-IDwill be changed to the event masks specified in the request.That value will be used for the IC&rsquo;s which have noindividual values.Using the Dynamic Event Flow model, an IM Server sendsXIM_REGISTER_TRIGGERKEYS message to the IM library beforesending XIM_OPEN_REPLY message. Or the IM library maysuppose that the IM Server uses the Static Event Flow model.XIM_REGISTER_TRIGGERKEYS is an asynchronous request. The IMServer notifys the IM library of on-keys and off-keys listswith this message.The IM library notifys the IM Server with XIM_TRIGGER_NOTIFYmessage that a key event matching either on-keys or off-keyshas been occurred.(*1) Specify the events currently selected by the IMlibrary with XSelectInput.XIM_TRIGGER_NOTIFY is a synchronous request. The IM libraryshould wait until receiving either anXIM_TRIGGER_NOTIFY_REPLY packet or an XIM_ERROR packet.4.6. Encoding NegotiationXIM_ENCODING_NEGOTIATION message requests to decide whichencoding to be sent across the wire. When the negotiationfails, the fallback default encoding is Portable CharacterEncoding.The IM Server must choose one encoding from the list sent bythe IM library. If index of the encording determined is -1to indicate that the negotiation is failed, the fallbackdefault encoding is used. The message must be issued aftersending XIM_OPEN message via XOpenIM(). The name ofencoding may be registered with X Consortium.XIM_ENCODING_NEGOTIATION is a synchronous request. The IMlibrary should wait until receiving either anXIM_ENCODING_NEGOTIATION_REPLY packet or an XIM_ERRORpacket.4.7. Query the supported extension protocol listXIM_QUERY_EXTENSION message requests to query the IMextensions supported by the IM Server to which the client isbeing connected.An example of a supported extension is FrontEnd. Themessage must be issued after sending XIM_OPEN message viaXOpenIM().If n is 0, the IM library queries the IM Server for allextensions.If n is not 0, the IM library queries whether the IM Serversupports the contents specified in the list.If a client uses an extension request without previouslyhaving issued a XIM_QUERY_EXTENSION message for thatextension, the IM Server responds with a BadProtocol error.If the IM Server encounters a request with an unknownMAJOR-OPCODE or MINOR-OPCODE, it responds with a BadProtocolerror.XIM_QUERY_EXTENSION is a synchronous request. The IMlibrary should wait until receiving either anXIM_QUERY_EXTENSION_REPLY packet or an XIM_ERROR packet.XIM_QUERY_EXTENSION_REPLY message returns the list ofextensions supported by both the IM library and the IMServer. If the list passed in XIM_QUERY_EXTENSION message isNULL, the IM Server returns the full list of extensionssupported by the IM Server. If the list is not NULL, the IMServer returns the extensions in the list that are supportedby the IM Server.A zero-length string is not a valid extension name. The IMlibrary should disregard any zero-length strings that arereturned in the extension list. The IM library does not usethe requests which are not supported by the IM Server.4.8. Setting IM ValuesXIM_SET_IM_VALUES requests to set attributes to the IM.The im-attributes in XIM_SET_IM_VALUES message are specifiedas a LISTofXIMATTRIBUTE, specifying the attributes to beset. Attributes other than the ones returned byXIM_OPEN_REPLY message should not be specified.XIM_SET_IM_VALUES is a synchronous request. The IM libraryshould wait until receiving either anXIM_SET_IM_VALUES_REPLY packet or an XIM_ERROR packet,because it must receive the error attribute if XIM_ERRORmessage is returned.XIM_SET_IM_VALUES_REPLY message returns the input-method-IDto distinguish replies from multiple IMs.4.9. Getting IM ValuesXIM_GET_IM_VALUES requests to query IM values supported bythe IM Server currently being connected.XIM_GET_IM_VALUES is a synchronous request. The IM libraryshould wait until it receives either anXIM_GET_IM_VALUES_REPLY packet or an XIM_ERROR packet.The IM Server returns IM values with XIM_GET_IM_VALUES_REPLYmessage. The order of the returned im-attribute valuescorresponds directly to that of the list passed with theXIM_GET_IM_VALUES message.4.10. Creating an ICXIM_CREATE_IC message requests to create an IC.The input-context-id is specified by the IM Server toidentify the client (IC). (It is not specified by theclient in XIM_CREATE_IC message.), and it should not be setto zero.XIM_CREATE_IC is a synchronous request which returns theinput-context-ID. The IM library should wait until itreceives either an XIM_CREATE_IC_REPLY packet or anXIM_ERROR packet.4.11. Destroying the ICXIM_DESTROY_IC message requests to destroy the IC.XIM_DESTROY_IC is a synchronous request. The IM libraryshould not free its resources until it receives anXIM_DESTROY_IC_REPLY message because XIM_DESTROY_IC messagemay result in Callback packets such as XIM_PREEDIT_DRAW andXIM_PREEDIT_DONE.4.12. Setting IC ValuesXIM_SET_IC_VALUES messages requests to set attributes to theIC.The ic-attributes in XIM_SET_IC_VALUES message are specifiedas a LISTofXICATTRIBUTE, specifying the attributes to beset. Attributes other than the ones returned byXIM_OPEN_REPLY message should not be specified.XIM_SET_IC_VALUES is a synchronous request. The IM libraryshould wait until receiving either anXIM_SET_IC_VALUES_REPLY packet or an XIM_ERROR packet,because it must receive the error attribute if XIM_ERRORmessage is returned.4.13. Getting IC ValuesXIM_GET_IC_VALUES message requests to query IC valuessupported by the IM Server currently being connected.In LISTofCARD16, the appearance of the ic-attribute-id forthe separator of NestedList shows the end of the headingnested list.XIM_GET_IC_VALUES is a synchronous request and returns eachattribute with its values to show the correspondence. TheIM library should wait until receiving either anXIM_GET_IC_VALUES_REPLY packet or an XIM_ERROR packet.4.14. Setting IC FocusXIM_SET_IC_FOCUS message requests to set the focus to theIC.XIM_SET_IC_FOCUS is an asynchronous request.4.15. Unsetting IC FocusXIM_UNSET_IC_FOCUS message requests to unset the focus tothe focused IC.XIM_UNSET_IC_FOCUS is an asynchronous request.4.16. Filtering EventsEvent filtering is mainly provided for BackEnd method toallow input method to capture X events transparently toclients.X Events are forwarded by XIM_FORWARD_EVENT message. Thismessage can be operated both synchronously andasynchronously. If the requester sets the synchronous flag,the receiver must send XIM_SYNC_REPLY message back to therequester when all the data processing is done.Protocol flow of BackEnd modelWith BackEnd method, the protocol flow can be classifiedinto two methods in terms of synchronization, depending onthe synchronous-eventmask of XIM_SET_EVENT_MASK message.One can be called on-demand-synchronous method and anothercan be called as full-synchronous method.In on-demand-synchronous method, the IM library alwaysreceives XIM_FORWARD_EVENT or XIM_COMMIT message as asynchronous request. Also, the IM Server needs tosynchronously process the correspondent reply from the IMlibrary and the following XIM_FORWARD_EVENT message sentfrom the IM library when any of the event causes the IMServer to send XIM_FORWARD_EVENT or XIM_COMMIT message tothe IM library, so that the input service is consistent. Ifthe IM library gets the control back from the applicationafter receiving the synchronous request, the IM libraryreplies for the synchronous request before processing any ofthe events. In this time, the IM Server blocksXIM_FORWARD_EVENT message which is sent by the IM library,and handles it after receiving the reply. However, the IMServer handles the other protocols at any time.In full-synchronous method, the IM library always sendsXIM_FORWARD_EVENT message to the IM Server as a synchronousrequest. Therefore, the reply to it from the IM Server willbe put between the XIM_FORWARD_EVENT message and itsXIM_SYNC_REPLY message. In case of sendingXIM_FORWARD_EVENT or XIM_COMMIT message, the IM Servershould set the synchronous flag off. Because thesynchronization can be done by the following XIM_SYNC_REPLYmessage.Sample Protocol flow chart 1Following chart shows one of the simplest protocol flowwhich only deals with keyevents for preediting operation.... 0.425 6.888 6.3 10.296 ... 0.000i 3.408i 5.875i 0.000iFig.2 Sample Protocol FlowSample Protocol flow chart 2Following chart shows one of the complex protocol flow,which deals with multiple focus windows and button pressevent as well as keyevent, and the focus is moved by theapplication triggered by both of keyevent and button pressevent. 4"></a>
</h3>


<p style="margin-top: 1em"><b>X Input Method Protocol
libX11 1.3.2</b></p>

<p style="margin-top: 1em">... 0.425 5.575 6.3 10.296 ...
0.000i 4.721i 5.875i 0.000i</p>


<p align="center" style="margin-top: 1em"><img src=".40.png" alt="Image .40.png"></p>

<p align="center" style="margin-top: 1em">Fig.3 Sample
Protocol Flow chart</p>


<p align="center" style="margin-top: 1em"><img src=".41.png" alt="Image .41.png"></p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="13%"></td>
<td width="10%">


<p style="margin-top: 1em">(*1)</p></td>
<td width="2%"></td>
<td width="75%">


<p style="margin-top: 1em">Indicate the receiver should
filter events and possible preedit may be invoked.</p></td></tr>
<tr valign="top" align="left">
<td width="13%"></td>
<td width="10%">


<p style="margin-top: 1em">(*2)</p></td>
<td width="2%"></td>
<td width="75%">


<p style="margin-top: 1em">Indicate the receiver should
only do lookup string. The IM Server is expected to just do
a conversion of the key event to the best candidate. This
bit may affect the state of the preedit state (e.g. compose
of dead key sequences).</p></td></tr>
</table>

<p style="margin-top: 1em">XEVENT format is same as the X
Protocol event format(xEvent). As the value of
xEvent&rsquo;s sequenceNumber is the bottom of 16 bit of
XEvent&rsquo;s xany.serial, the top of 16 bit is sent by
serial number(INT16).</p>

<p style="margin-top: 1em"><i>XIM_FORWARD_EVENT</i> message
is used for forwarding the events from the IM library to the
IM Server in order for IM to be able to filter the event. On
the other hand, this message is also used for forwarding the
events from the IM Server to the IM library if the event
forwarded from the IM library is not filtered. The IM
Server, which receives <i>XIM_FORWARD_EVENT</i> message
without synchronous bit, should set synchronous bit. If both
&lsquo;&lsquo;request event filtering&rsquo;&rsquo; and
&lsquo;&lsquo;request lookupstring&rsquo;&rsquo; flag are
set, then both filtering and lookup should be done for the
same event.</p>

<h3>4.17. Synchronizing with the IM ServerXIM_SYNC message requests to synchronize the IM library andthe IM Server.This synchronization can be started either on the IM libraryside or on the IM Server side. The side which receivesXIM_SYNC message should process all XIM requests beforereplying. The input-context-ID is necessary to distinguishthe IC with which the IM library and the IM Server aresynchronized.The side which receives XIM_FORWARD_EVENT, XIM_COMMIT or anyother message with synchronous bit, should process all XIMrequest before replying, and send XIM_SYNC_REPLY message asthe reply to the previous message.4.18. Sending a committed stringWhen the IM Server commits a string, the IM Server sendseither the committed string or list of KeySym, or both, byXIM_COMMIT message.If flag is XLookupKeySym, the arguments continue asfollows:If flag is XLookupChars, the arguments continue asfollows:If flag is XLookupBoth, the arguments continue asfollows:The IM Server which receives XIM_COMMIT message withoutsynchronous bit should set synchronous bit.4.19. Reset ICXIM_RESET_IC message requests to reset the status of IC inthe IM Server.XIM_RESET_IC is a synchronous request. The IM library shouldwait until receiving either an XIM_RESET_IC_REPLY packet oran XIM_ERROR packet.XIM_RESET_IC_REPLY message returns the input-context-ID todistinguish replies from multiple ICs.4.20. CallbacksIf XIMStyle has XIMPreeditArea or XIMStatusArea set,XIMGeometryCallback may be used, and if XIMPreeditCallbackand/or XIMStatusCallback are set, corresponding callbacksmay be used.Any callback request may be sent from an IM Server to an IMclient asynchronously in response to any request previouslysent by the IM client to the IM Server.When an IM Server needs to send a callback requestsynchronously with the request previously sent by an IMclient, the IM Server sends it before replying to theprevious request.4.20.1. Negotiating geometryThe IM Server sends XIM_GEOMETRY message to start geometrynegotiation, if XIMStyle has XIMPreeditArea or XIMStatusAreaset.There is always a single Focus Window, even if some inputfields have only one IC.4.20.2. Converting a stringXIM_STR_CONVERSION message may be used to start the stringconversion from the IM Server.XIM_STR_CONVERSION_REPLY message returns the string to beconverted and the feedback information array.4.20.3. Preedit CallbacksThe IM Server sends XIM_PREEDIT_START message to call theXIMPreeditStartCallback function.The reply to this message must be sent synchronously. Thereply forwards the return value from the callback functionto the IM Server.XIM_PREEDIT_START_REPLY message returns the input-context-IDto distinguish replies from multiple IC&rsquo;s. The return valuecontains the return value of the functionXIMPreeditStartCallback.The IM Server sends XIM_PREEDIT_DRAW message to call theXIMPreeditDrawCallback function.The fields &lsquo;&lsquo;caret&rsquo;&rsquo;, &lsquo;&lsquo;chg_first&rsquo;&rsquo; and &lsquo;&lsquo;chg_length&rsquo;&rsquo;correspond to the fields of XIMPreeditDrawCallbackStruct.When the &lsquo;&lsquo;no string&rsquo;&rsquo; bit of the status field is set, thetext field of XIMPreeditDrawCallbackStruct is NULL. Whenthe &lsquo;&lsquo;no feedback&rsquo;&rsquo; bit of the status field is set, the textfeedback field of XIMPreeditDrawCallbackStruct is NULL.When the above bits are not set, &lsquo;&lsquo;preedit string&rsquo;&rsquo; containsthe preedit string to be displayed, and the feedback arraycontains feedback information.The IM Server sends XIM_PREEDIT_CARET message to call thePreeditCaretCallback function.Each entry corresponds to a field ofXIMPreeditCaretCallbackStruct. Since this callback sets thecaret position, its reply must be sent synchronously.The position is the value returned by the callback functionafter it has been called.The IM Server sends XIM_PREEDIT_DONE message to call theXIMPreeditDoneCallback function.4.20.4. Preedit state notifyXIM_PREEDITSTATE message is used to call theXIMPreeditStateNotifyCallback function.4.20.5. Status CallbacksThe IM Server sends XIM_STATUS_START message to call theXIMStatusStartCallback function.XIM_STATUS_START (IM Server &rarr; IM library)2 CARD16 input-method-ID2 CARD16 input-context-IDThe IM Server sends XIM_STATUS_DRAW message to call theXIMStatusDrawCallback function.XIM_STATUS_DRAW (IM Server &rarr; IM library)2 CARD16 input-method-ID2 CARD16 input-context-ID4 CARD32 type#0 XIMTextType#1 XIMBitmapTypeIf type is XIMTextType, the arguments continue asfollows.4 BITMASK32 status#x0000001 no string#x0000002 no feedback2 n length of status stringn STRING8 status stringp unused, p = Pad(2+n)2 m byte length of feedback array2 unusedm LISTofXIMFEEDBACK feedback arrayIf type is XIMBitmapType, the arguments continue asfollows.4 PIXMAP pixmap dataThe field &lsquo;&lsquo;type&rsquo;&rsquo; corresponds to the field inXIMStatusDrawCallbackStruct.The IM Server sends XIM_STATUS_DONE message to call theXIMStatusDoneCallback function.XIM_STATUS_DONE (IM Server &rarr; IM library)2 CARD16 input-method-ID2 CARD16 input-context-ID5
<a name="4.17. Synchronizing with the IM ServerXIM_SYNC message requests to synchronize the IM library andthe IM Server.This synchronization can be started either on the IM libraryside or on the IM Server side. The side which receivesXIM_SYNC message should process all XIM requests beforereplying. The input-context-ID is necessary to distinguishthe IC with which the IM library and the IM Server aresynchronized.The side which receives XIM_FORWARD_EVENT, XIM_COMMIT or anyother message with synchronous bit, should process all XIMrequest before replying, and send XIM_SYNC_REPLY message asthe reply to the previous message.4.18. Sending a committed stringWhen the IM Server commits a string, the IM Server sendseither the committed string or list of KeySym, or both, byXIM_COMMIT message.If flag is XLookupKeySym, the arguments continue asfollows:If flag is XLookupChars, the arguments continue asfollows:If flag is XLookupBoth, the arguments continue asfollows:The IM Server which receives XIM_COMMIT message withoutsynchronous bit should set synchronous bit.4.19. Reset ICXIM_RESET_IC message requests to reset the status of IC inthe IM Server.XIM_RESET_IC is a synchronous request. The IM library shouldwait until receiving either an XIM_RESET_IC_REPLY packet oran XIM_ERROR packet.XIM_RESET_IC_REPLY message returns the input-context-ID todistinguish replies from multiple ICs.4.20. CallbacksIf XIMStyle has XIMPreeditArea or XIMStatusArea set,XIMGeometryCallback may be used, and if XIMPreeditCallbackand/or XIMStatusCallback are set, corresponding callbacksmay be used.Any callback request may be sent from an IM Server to an IMclient asynchronously in response to any request previouslysent by the IM client to the IM Server.When an IM Server needs to send a callback requestsynchronously with the request previously sent by an IMclient, the IM Server sends it before replying to theprevious request.4.20.1. Negotiating geometryThe IM Server sends XIM_GEOMETRY message to start geometrynegotiation, if XIMStyle has XIMPreeditArea or XIMStatusAreaset.There is always a single Focus Window, even if some inputfields have only one IC.4.20.2. Converting a stringXIM_STR_CONVERSION message may be used to start the stringconversion from the IM Server.XIM_STR_CONVERSION_REPLY message returns the string to beconverted and the feedback information array.4.20.3. Preedit CallbacksThe IM Server sends XIM_PREEDIT_START message to call theXIMPreeditStartCallback function.The reply to this message must be sent synchronously. Thereply forwards the return value from the callback functionto the IM Server.XIM_PREEDIT_START_REPLY message returns the input-context-IDto distinguish replies from multiple IC&rsquo;s. The return valuecontains the return value of the functionXIMPreeditStartCallback.The IM Server sends XIM_PREEDIT_DRAW message to call theXIMPreeditDrawCallback function.The fields &lsquo;&lsquo;caret&rsquo;&rsquo;, &lsquo;&lsquo;chg_first&rsquo;&rsquo; and &lsquo;&lsquo;chg_length&rsquo;&rsquo;correspond to the fields of XIMPreeditDrawCallbackStruct.When the &lsquo;&lsquo;no string&rsquo;&rsquo; bit of the status field is set, thetext field of XIMPreeditDrawCallbackStruct is NULL. Whenthe &lsquo;&lsquo;no feedback&rsquo;&rsquo; bit of the status field is set, the textfeedback field of XIMPreeditDrawCallbackStruct is NULL.When the above bits are not set, &lsquo;&lsquo;preedit string&rsquo;&rsquo; containsthe preedit string to be displayed, and the feedback arraycontains feedback information.The IM Server sends XIM_PREEDIT_CARET message to call thePreeditCaretCallback function.Each entry corresponds to a field ofXIMPreeditCaretCallbackStruct. Since this callback sets thecaret position, its reply must be sent synchronously.The position is the value returned by the callback functionafter it has been called.The IM Server sends XIM_PREEDIT_DONE message to call theXIMPreeditDoneCallback function.4.20.4. Preedit state notifyXIM_PREEDITSTATE message is used to call theXIMPreeditStateNotifyCallback function.4.20.5. Status CallbacksThe IM Server sends XIM_STATUS_START message to call theXIMStatusStartCallback function.XIM_STATUS_START (IM Server &rarr; IM library)2 CARD16 input-method-ID2 CARD16 input-context-IDThe IM Server sends XIM_STATUS_DRAW message to call theXIMStatusDrawCallback function.XIM_STATUS_DRAW (IM Server &rarr; IM library)2 CARD16 input-method-ID2 CARD16 input-context-ID4 CARD32 type#0 XIMTextType#1 XIMBitmapTypeIf type is XIMTextType, the arguments continue asfollows.4 BITMASK32 status#x0000001 no string#x0000002 no feedback2 n length of status stringn STRING8 status stringp unused, p = Pad(2+n)2 m byte length of feedback array2 unusedm LISTofXIMFEEDBACK feedback arrayIf type is XIMBitmapType, the arguments continue asfollows.4 PIXMAP pixmap dataThe field &lsquo;&lsquo;type&rsquo;&rsquo; corresponds to the field inXIMStatusDrawCallbackStruct.The IM Server sends XIM_STATUS_DONE message to call theXIMStatusDoneCallback function.XIM_STATUS_DONE (IM Server &rarr; IM library)2 CARD16 input-method-ID2 CARD16 input-context-ID5"></a>
</h3>


<p style="margin-top: 1em"><b>X Input Method Protocol
libX11 1.3.2</b></p>

<h2>5. AcknowledgementsThis document represents the culmination of several years ofdebate and experiments done under the auspices of the MIT XConsortium i18n working group. Although this was a groupeffort, the author remains responsible for any errors oromissions.We would like to thank to all members of this group. And wewould like to make special thanks to the following people(in alphabetical order) for their participation in the IMProtocol design, Hector Chan, Takashi Fujiwara, YoshioHoriuchi, Makoto Inada, Hiromu Inukai, Mickael Kung, SeijiKuwari, Franky Ling, Hiroyuki Machida, Hiroyuki Miyamoto,Frank Rojas, Bob Scheifler, Makiko Shimamura, ShojiSugiyama, Hidetoshi Tajima, Masaki Takeuchi, MakotoWakamatsu, Masaki Wakao, Nobuyuki Tanaka, Shigeru Yamada,Katsuhisa Yano, Jinsoo Yoon.6. ReferencesAll of the following documents are X Consortium standardsavailable from MIT:[1] Scheifler, Robert W., &lsquo;&lsquo;X Window System Protocol Version11&rsquo;&rsquo;[2] Scheifler, Robert W. etc., &lsquo;&lsquo;Xlib &minus; C Language XInterface&rsquo;&rsquo; 6
<a name="5. AcknowledgementsThis document represents the culmination of several years ofdebate and experiments done under the auspices of the MIT XConsortium i18n working group. Although this was a groupeffort, the author remains responsible for any errors oromissions.We would like to thank to all members of this group. And wewould like to make special thanks to the following people(in alphabetical order) for their participation in the IMProtocol design, Hector Chan, Takashi Fujiwara, YoshioHoriuchi, Makoto Inada, Hiromu Inukai, Mickael Kung, SeijiKuwari, Franky Ling, Hiroyuki Machida, Hiroyuki Miyamoto,Frank Rojas, Bob Scheifler, Makiko Shimamura, ShojiSugiyama, Hidetoshi Tajima, Masaki Takeuchi, MakotoWakamatsu, Masaki Wakao, Nobuyuki Tanaka, Shigeru Yamada,Katsuhisa Yano, Jinsoo Yoon.6. ReferencesAll of the following documents are X Consortium standardsavailable from MIT:[1] Scheifler, Robert W., &lsquo;&lsquo;X Window System Protocol Version11&rsquo;&rsquo;[2] Scheifler, Robert W. etc., &lsquo;&lsquo;Xlib &minus; C Language XInterface&rsquo;&rsquo; 6"></a>
</h2>


<p style="margin-top: 1em"><b>X Input Method Protocol
libX11 1.3.2</b></p>

<p align="center" style="margin-top: 1em"><b><big>Appendix
A</big></b></p>

<p align="center" style="margin-top: 1em"><b>Common
Extensions</b></p>

<p style="margin-top: 1em"><small>Extension opcodes and
packet names (e.g. <i>XIM_EXT_SET_EVENT_MASK</i> ) for
additional extensions may be registered with X Consortium.
The following is a commonly well-known extended
packet.</small></p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="8%">


<p style="margin-top: 1em"><small><b>(1)</b></small></p></td>
<td width="5%"></td>
<td width="87%">


<p style="margin-top: 1em"><small>Extension to manipulate
the event handling</small></p></td></tr>
</table>


<p style="margin-top: 1em"><small><i>XIM_EXT_SET_EVENT_MASK</i>
message specifies the set of event masks that the IM library
should manipulate.</small></p>


<p style="margin-left:30%;"><small><b>XIM_EXT_SET_EVENT_MASK
(IM Server &rarr; IM library)</b> <br>
2 CARD16 input-method-ID <br>
2 CARD16 input-context-ID <br>
4 EVENTMASK filter-event-mask (*1) <br>
4 EVENTMASK intercept-event-mask (*2) <br>
4 EVENTMASK select-event-mask (*3) <br>
4 EVENTMASK forward-event-mask (*4) <br>
4 EVENTMASK synchronous-event-mask (*5)</small></p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="13%"></td>
<td width="10%">


<p style="margin-top: 1em"><small>(*1)</small></p></td>
<td width="2%"></td>
<td width="75%">


<p style="margin-top: 1em"><small>Specify the events to be
neglected by the IM library via XFilterEvent.</small></p></td></tr>
<tr valign="top" align="left">
<td width="13%"></td>
<td width="10%">


<p style="margin-top: 1em"><small>(*2)</small></p></td>
<td width="2%"></td>
<td width="75%">


<p style="margin-top: 1em"><small>Specify the events to be
deselected by the IM library with XSelectInput.</small></p></td></tr>
<tr valign="top" align="left">
<td width="13%"></td>
<td width="10%">


<p style="margin-top: 1em"><small>(*3)</small></p></td>
<td width="2%"></td>
<td width="75%">


<p style="margin-top: 1em"><small>Specify the events to be
selected by the IM library with XSelectInput.</small></p></td></tr>
<tr valign="top" align="left">
<td width="13%"></td>
<td width="10%">


<p style="margin-top: 1em"><small>(*4)</small></p></td>
<td width="2%"></td>
<td width="75%">


<p style="margin-top: 1em"><small>Specify all the events to
be forwarded to the IM Server by the IM library.</small></p></td></tr>
<tr valign="top" align="left">
<td width="13%"></td>
<td width="10%">


<p style="margin-top: 1em"><small>(*5)</small></p></td>
<td width="2%"></td>
<td width="75%">


<p style="margin-top: 1em"><small>Specify the events to be
forwarded with synchronous flag on by the IM
library.</small></p> </td></tr>
</table>

<p style="margin-top: 1em"><small>The IM library must reply
<i>XIM_SYNC_REPLY</i> message to the IM Server. This request
is valid after the ic is created.</small></p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="8%">


<p style="margin-top: 1em"><small><b>(2)</b></small></p></td>
<td width="5%"></td>
<td width="87%">


<p style="margin-top: 1em"><small>Extension for improvement
of performance</small></p></td></tr>
</table>

<p style="margin-top: 1em"><small>The following requests
may be used for improvement of performance.</small></p>


<p style="margin-top: 1em"><small><i>XIM_EXT_FORWARD_KEYEVENT</i>
message may be used instead of <i>XIM_FORWARD_EVENT</i>
message.</small></p>


<p style="margin-left:30%;"><small><b>XIM_EXT_FORWARD_KEYEVENT
(IM Server &larr;&rarr; IM library)</b> <br>
2 CARD16 input-method-ID <br>
2 CARD16 input-context-ID <br>
2 BITMASK16 flag <br>
#0001 synchronous <br>
2 CARD16 sequence number <br>
1 BYTE xEvent.u.u.type <br>
1 BYTE keycode <br>
2 CARD16 state <br>
4 CARD32 time <br>
4 CARD32 window</small></p>

<p><small><b>7</b></small></p>

<p style="margin-top: 1em"><b>X Input Method Protocol
libX11 1.3.2</b></p>

<p style="margin-top: 1em"><i>XIM_EXT_MOVE</i> message may
be used to change the spot location instead of
XIM_SET_IC_VALUES message. It is effective only if the
client specified XIMPreeditPosition.</p>

<p style="margin-left:30%;"><b>XIM_EXT_MOVE (IM library
&rarr; IM Server)</b> <br>
2 CARD16 input-method-ID <br>
2 CARD16 input-context-ID <br>
2 INT16 X <br>
2 INT16 Y</p>

<p style="margin-top: 1em"><i>XIM_EXT_MOVE</i> message is a
asynchronous request.</p>

<p style="margin-top: 1em"><b>8</b></p>

<p style="margin-top: 1em"><b>X Input Method Protocol
libX11 1.3.2</b></p>

<p align="center" style="margin-top: 1em"><b><big>Appendix
B</big></b></p>

<p align="center" style="margin-top: 1em"><b>The list of
transport specific IM Server address format
registered</b></p>

<p style="margin-top: 1em"><small>The following format
represents the ATOM contained in <i>XIM_SERVERS</i> property
and the string returned from the request converting
selection target LOCALES and TRANSPORT.</small></p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="25%"></td>
<td width="75%">



<p><small>&lsquo;&lsquo;{@<i>category</i>=[<i>value</i>,...]}...&rsquo;&rsquo;</small></p> </td></tr>
</table>

<p style="margin-top: 1em"><small>The following categories
are currently registered.</small></p>

<p style="margin-left:30%;"><small><b>server</b> : IM
Server name (used for XIM_SERVERS) <b><br>
locale</b> : XPG4 locale name (LOCALES) <b><br>
transport</b> : transport-specific name
(TRANSPORT)</small></p>

<p style="margin-top: 1em"><small>The preregistered formats
for transport-specific names are as follows:</small></p>


<p style="margin-left:30%; margin-top: 1em"><small><b>TCP/IP
Names</b></small></p>

<p style="margin-left:40%; margin-top: 1em"><small>The
following syntax should be used for system internal domain
names:</small></p>


<p style="margin-left:50%; margin-top: 1em"><small>&lt;<i>local
name</i>&gt; ::=
&lsquo;&lsquo;local/&rsquo;&rsquo;&lt;<i>hostname</i>&gt;&lsquo;&lsquo;:&rsquo;&rsquo;&lt;<i>pathname</i>&gt;</small></p>

<p style="margin-left:40%; margin-top: 1em"><small>Where
&lt;<i>pathname</i>&gt; is a path name of socket
address.</small></p>

<p style="margin-left:40%; margin-top: 1em"><small>IM
Server&rsquo;s name should be set to &lt;<i>pathname</i>&gt;
to run multiple IM Server at the same time</small></p>

<p style="margin-left:40%; margin-top: 1em"><small>The
following syntax should be used for Internet domain
names:</small></p>


<p style="margin-left:50%; margin-top: 1em"><small>&lt;<i>TCP
name</i>&gt; ::=
&lsquo;&lsquo;tcp/&rsquo;&rsquo;&lt;<i>hostname</i>&gt;&lsquo;&lsquo;:&rsquo;&rsquo;&lt;<i>ipportnumber</i>&gt;</small></p>

<p style="margin-left:40%; margin-top: 1em"><small>where
&lt;<i>hostname</i>&gt; is either symbolic (such as
expo.lcs.mit.edu) or numeric decimal (such as 18.30.0.212).
The &lt;<i>ipportnumber</i>&gt; is the port on which the IM
Server is listening for connections. For
example:</small></p>


<p style="margin-left:50%; margin-top: 1em"><small>tcp/expo.lcs.mit.edu:8012
<br>
tcp/18.30.0.212:7890</small></p>


<p style="margin-left:30%; margin-top: 1em"><small><b>DECnet
Names</b></small></p>

<p style="margin-left:40%; margin-top: 1em"><small>The
following syntax should be used for DECnet
names:</small></p>


<p style="margin-left:50%; margin-top: 1em"><small>&lt;<i>DECnet
name</i>&gt; ::=
&lsquo;&lsquo;decnet/&rsquo;&rsquo;&lt;<i>nodename</i>&gt;&lsquo;&lsquo;::IMSERVER$&rsquo;&rsquo;&lt;<i>objname</i>&gt;</small></p>

<p style="margin-left:40%; margin-top: 1em"><small>where
&lt;<i>nodename</i>&gt; is either symbolic (such as SRVNOD)
or the numeric decimal form of the DECnet address (such as
44.70). The &lt;<i>objname</i>&gt; is normal,
case-insensitive DECnet object name. For
example:</small></p>


<p style="margin-left:50%; margin-top: 1em"><small>DECNET/SRVNOD::IMSERVER$DEFAULT
<br>
decnet/44.70::IMSERVER$other</small></p>

<p style="margin-left:30%; margin-top: 1em"><small><b>X
Names</b></small></p>

<p style="margin-left:40%; margin-top: 1em"><small>The
following syntax should be used for X names:</small></p>


<p style="margin-left:50%; margin-top: 1em"><small>&lt;<i>X
name</i>&gt; ::= &lsquo;&lsquo;X/&rsquo;&rsquo;</small></p>

<p style="margin-top: 1em"><small>If a given category has
multiple values, the value is evaluated in order of setting.
<b><br>
9</b></small></p>

<p style="margin-top: 1em"><b>X Input Method Protocol
libX11 1.3.2</b></p>

<p align="center" style="margin-top: 1em"><b><big>Appendix
C</big></b></p>

<p align="center" style="margin-top: 1em"><b>Protocol
number</b></p>

<p style="margin-top: 1em"><b><small>Major Protocol
number</small></b></p>

<p style="margin-left:978%;"><small>XIM_CONNECT #001 <br>
XIM_CONNECT_REPLY #002 <br>
XIM_DISCONNECT #003 <br>
XIM_DISCONNECT_REPLY #004 <br>
XIM_AUTH_REQUIRED #010 <br>
XIM_AUTH_REPLY #011 <br>
XIM_AUTH_NEXT #012 <br>
XIM_AUTH_SETUP #013 <br>
XIM_AUTH_NG #014 <br>
XIM_ERROR #020 <br>
XIM_OPEN #030 <br>
XIM_OPEN_REPLY #031 <br>
XIM_CLOSE #032 <br>
XIM_CLOSE_REPLY #033 <br>
XIM_REGISTER_TRIGGERKEYS #034 <br>
XIM_TRIGGER_NOTIFY #035 <br>
XIM_TRIGGER_NOTIFY_REPLY #036 <br>
XIM_SET_EVENT_MASK #037 <br>
XIM_ENCODING_NEGOTIATION #038 <br>
XIM_ENCODING_NEGOTIATION_REPLY #039 <br>
XIM_QUERY_EXTENSION #040 <br>
XIM_QUERY_EXTENSION_REPLY #041 <br>
XIM_SET_IM_VALUES #042 <br>
XIM_SET_IM_VALUES_REPLY #043 <br>
XIM_GET_IM_VALUES #044 <br>
XIM_GET_IM_VALUES_REPLY #045 <br>
XIM_CREATE_IC #050 <br>
XIM_CREATE_IC_REPLY #051 <br>
XIM_DESTROY_IC #052 <br>
XIM_DESTROY_IC_REPLY #053 <br>
XIM_SET_IC_VALUES #054 <br>
XIM_SET_IC_VALUES_REPLY #055 <br>
XIM_GET_IC_VALUES #056 <br>
XIM_GET_IC_VALUES_REPLY #057 <br>
XIM_SET_IC_FOCUS #058 <br>
XIM_UNSET_IC_FOCUS #059 <br>
XIM_FORWARD_EVENT #060 <br>
XIM_SYNC #061 <br>
XIM_SYNC_REPLY #062 <br>
XIM_COMMIT #063 <br>
XIM_RESET_IC #064 <br>
XIM_RESET_IC_REPLY #065 <br>
XIM_GEOMETRY #070 <br>
XIM_STR_CONVERSION #071 <br>
XIM_STR_CONVERSION_REPLY #072 <br>
XIM_PREEDIT_START #073 <br>
XIM_PREEDIT_START_REPLY #074 <br>
XIM_PREEDIT_DRAW #075 <br>
XIM_PREEDIT_CARET #076 <br>
XIM_PREEDIT_CARET_REPLY #077 <br>
XIM_PREEDIT_DONE #078 <br>
XIM_STATUS_START #079 <br>
XIM_STATUS_DRAW #080 <br>
XIM_STATUS_DONE #081 <br>
XIM_PREEDITSTATE #082</small></p>

<p style="margin-top: 1em"><small>(*) The IM Server&rsquo;s
extension protocol number should be more than #128. <b><br>
10</b></small></p>

<p style="margin-top: 1em"><b>X Input Method Protocol
libX11 1.3.2</b></p>

<p align="center" style="margin-top: 1em"><b><big>Appendix
D</big></b></p>


<p align="center" style="margin-top: 1em"><b>Implementation
Tips</b></p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="8%">


<p style="margin-top: 1em"><b><small>(1)</small></b></p></td>
<td width="5%"></td>
<td width="37%">


<p style="margin-top: 1em"><small>FrontEnd
Method</small></p> </td>
<td width="50%">
</td></tr>
</table>

<p style="margin-top: 1em"><small>FrontEnd method is
recognized as a performance acceleration by the trade off of
the variety of the reliability.</small></p>

<p style="margin-top: 1em"><small>In order to use the
FrontEnd method, the IM library must query the IM Server to
see if the FrontEnd extension is available. The query is
made by using the <i>XIM_QUERY_EXTENSION</i> message. The IM
Server may send <i>XIM_EXT_SET_EVENT_MASK</i> message with
intercept-event-mask, forward-event-mask, and
synchronous-event-mask values set after replying
<i>XIM_QUERY_EXTENSION_REPLY</i> message.</small></p>

<p style="margin-top: 1em"><small>FrontEnd method can be
implemented in a couple of ways depending on how the IM
Server utilize <i>XIM_EXT_SET_EVENT_MASK</i>
message.</small></p>

<p style="margin-top: 1em"><small>One approach is to update
both of the input mask and the filter-event-mask depending
on the preeidting state. The sample protocol sequence using
the static event flow is as follows:</small></p>

<p style="margin-top: 1em"><small>... 1.675 6.888 6.237
10.296 ... 0.000i 3.408i 4.562i 0.000i &#9474; &#9474;
&#9474; &#9474; &#9474; &#9474; &#9474; &#9474; &#9474;
&#9474; &#9474; &#9474; &#9474; &#9474; &#9474; &#9474;
&#9474; &#9474; &#9474; &#9474; _______</small></p>

<p style="margin-left:34%; margin-top: 1em">IM Server
<small><br>
event mask is changed <br>
to select the event <br>
event mask is changed <br>
to deselect the event <br>
X events directly come <br>
to the IM Server. <br>
when preediting is turning off _________ _________________
_________________ &#9474; &#9474; &#9474; &#9474; &#9474;
&#9474; &#9474; &#9474; &#9474; &#9474; &#9474; &#9474;
&#9474; &#9474; &#9474; &#9474; &#9474; &#9474; &#9474;
&#9474; _________________ <br>
XIM_EXT_SET_EVENT_MASK <br>
intercept-event-mask is set <br>
XIM_EXT_SET_EVENT_MASK <br>
select-event-mask is set</small> <br>
IM library <small><br>
Keys in the on-key-list <br>
event mask is changed <br>
to select the event <br>
to deselect the event <br>
event mask is changed <br>
XIM_FORWARD_EVENT</small></p>

<p style="margin-top: 1em">To pursuit a maximum performance
regardless of the preediting mode, the IM Server may use the
dynamic event flow with the following sample protocol
sequence. <b><br>
11</b></p>

<p style="margin-top: 1em"><b>X Input Method Protocol
libX11 1.3.2</b></p>

<p style="margin-top: 1em">... 1.675 6.888 6.237 10.296 ...
0.000i 3.408i 4.562i 0.000i &#9474; &#9474; &#9474; &#9474;
&#9474; &#9474; &#9474; &#9474; &#9474; &#9474; &#9474;
&#9474; &#9474; &#9474; &#9474; &#9474; &#9474; &#9474;
&#9474; &#9474; _______</p>

<p style="margin-left:34%; margin-top: 1em"><big>IM
Server</big> <br>
event mask is changed <br>
to select the event <br>
event mask is changed <br>
to deselect the event <br>
X events directly come <br>
to the IM Server. <br>
when preediting is turning off _________ _________________
_________________ _________________ &#9474; &#9474; &#9474;
&#9474; &#9474; &#9474; &#9474; &#9474; &#9474; &#9474;
&#9474; &#9474; &#9474; &#9474; &#9474; &#9474; &#9474;
&#9474; &#9474; &#9474; _________________ <br>
XIM_TRIGGER_NOTIFY <br>
XIM_TRIGGER_NOTIFY_REPLY <br>
XIM_EXT_SET_EVENT_MASK <br>
intercept-event-mask is set <br>
XIM_EXT_SET_EVENT_MASK <br>
select-event-mask is set <big><br>
IM library</big> <br>
Keys in the on-key-list <br>
event mask is changed <br>
to select the event <br>
to deselect the event <br>
event mask is changed</p>

<p style="margin-top: 1em"><big>This method can reduce the
XIM protocol traffic dramatically by updating
intercept-event-mask and select-event-mask accordingly. The
tradeoff of this performance improvement is that the key
events may be lost or disordered in some particular
situation, such as when the user types the keyboard in
following sequence really fast:</big></p>

<p style="margin-left:30%;"><big>&lt;preediting on
key&gt;&lsquo;&lsquo;some
strings&rsquo;&rsquo;&lt;preediting off
key&gt;&lsquo;&lsquo;another string&rsquo;&rsquo;</big></p>

<p><big>Since this method requires the input mask updates
to the both the IM Server and Xlib when turning on and off
the preediting, and there is a time lag till the requests
take effect when two client issues the input mask updates
simultaneously.</big></p>

<p style="margin-top: 1em"><big>Another approach of the
FrontEnd method is to update the filter-event-mask depending
on the preediting state and not to update the input mask.
The IM Server must register both of the preediting on key
list and off key list by <i>XIM_REGISTER_TRIGGERKEYS</i>
message. In this method, Both the IM Server and the IM
client select the same events on the same client&rsquo;s
window, so that the events are delivered to both of the IM
Server and the client. The preediting on and off states are
expressed by whether the key events are filtered or not. The
sample protocol sequence are as follows:</big></p>

<p style="margin-top: 1em"><big><b>12</b></big></p>

<p style="margin-top: 1em"><b>X Input Method Protocol
libX11 1.3.2</b></p>

<p style="margin-top: 1em">&lt;&lt;Using static event
flow&gt;&gt;</p>

<p style="margin-top: 1em">... 1.488 7.325 6.487 10.358 ...
0.000i 3.033i 4.999i 0.000i __________ __________ &#9474;
&#9474; &#9474; &#9474; &#9474; &#9474; &#9474; &#9474;
&#9474; &#9474; &#9474; &#9474; &#9474; &#9474; &#9474;
&#9474; &#9474; &#9474;</p>

<p style="margin-left:30%; margin-top: 1em"><big>IM
Server</big> <br>
the specified events <br>
are being processed <br>
the specified events <br>
are being discarded <br>
Keys in the off-key-list <br>
Keys in the on-key-list_________ _________________&#9474;
&#9474; &#9474; &#9474; &#9474; &#9474; &#9474; &#9474;
&#9474; &#9474; &#9474; &#9474; &#9474; &#9474; &#9474;
&#9474; &#9474; &#9474; _________________ _________
_________________ <br>
XIM_EXT_SET_EVENT_MASK <br>
Keys in the on-key-list <br>
filter-event-mask is set <br>
the specified events <br>
are being filtered <br>
XIM_EXT_SET_EVENT_MASK <br>
filter-event-mask is set <br>
Keys in the off-key-list <big><br>
IM library</big> <br>
the specified events <br>
are being processed <br>
XIM_FORWARD_EVENT</p>

<p style="margin-top: 1em"><big>&lt;&lt;Using the dynamic
event flow&gt;&gt;</big></p>

<p style="margin-top: 1em"><big>... 1.488 7.325 6.487
10.358 ... 0.000i 3.033i 4.999i 0.000i __________ __________
&#9474; &#9474; &#9474; &#9474; &#9474; &#9474; &#9474;
&#9474; &#9474; &#9474; &#9474; &#9474; &#9474; &#9474;
&#9474; &#9474; &#9474; &#9474;</big></p>

<p style="margin-left:30%; margin-top: 1em"><big><big>IM
Server</big> <br>
the specified events <br>
are being processed <br>
the specified events <br>
are being discarded <br>
Keys in the off-key-list <br>
Keys in the on-key-list_________ _________________
_________________ &#9474; &#9474; &#9474; &#9474; &#9474;
&#9474; &#9474; &#9474; &#9474; &#9474; &#9474; &#9474;
&#9474; &#9474; &#9474; &#9474; &#9474; &#9474;
_________________ _________ _________________ <br>
XIM_TRIGGER_NOTIFY <br>
XIM_TRIGGER_NOTIFY_REPLY <br>
XIM_EXT_SET_EVENT_MASK <br>
Keys in the on-key-list <br>
filter-event-mask is set <br>
the specified events <br>
are being filtered <br>
XIM_EXT_SET_EVENT_MASK <br>
filter-event-mask is set <br>
Keys in the off-key-list <big><br>
IM library</big> <br>
the specified events <br>
are being processed</big></p>

<p style="margin-top: 1em"><big><big>This method does not
have the problem of the time lag when going across the
preediting on and off mode, however, the amount of the
performance acceleration is not as good as the method
described above.</big></big></p>

<p style="margin-top: 1em"><big><big>In general, the
FrontEnd method requires some synchronization to some of the
X protocols, such as the ChangeWindowAttribute protocol for
the event mask change or the GrabKey protocol, since it
relies on the X&rsquo;s principal event dispatching
mechanism. Any X protocol bindings do not consider the
synchronization might cause some mis-synchronization between
the IM clients and the IM Server.</big></big></p>


<p style="margin-top: 1em"><big><big><b>13</b></big></big></p>

<p style="margin-top: 1em"><b>X Input Method Protocol
libX11 1.3.2</b></p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="8%">


<p style="margin-top: 1em"><b>(2)</b></p></td>
<td width="5%"></td>
<td width="37%">


<p style="margin-top: 1em">Transport Layer</p></td>
<td width="50%">
</td></tr>
</table>

<p style="margin-top: 1em">The Xlib XIM implementation is
layered into three functions, a protocol layer, an interface
layer and a transport layer. The purpose of this layering is
to make the protocol independent of transport
implementation. Each function of these layers are:</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="13%"></td>
<td width="45%">


<p style="margin-top: 1em"><i>The protocol layer</i></p></td>
<td width="42%">
</td></tr>
</table>

<p style="margin-left:40%;">implements overall function of
XIM and calls the interface layer functions when it needs to
communicate to IM Server.</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="13%"></td>
<td width="47%">


<p style="margin-top: 1em"><i>The interface layer</i></p></td>
<td width="40%">
</td></tr>
</table>

<p style="margin-left:40%;">separates the implementation of
the transport layer from the protocol layer, in other words,
it provides implementation independent hook for the
transport layer functions.</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="13%"></td>
<td width="47%">


<p style="margin-top: 1em"><i>The transport layer</i></p></td>
<td width="40%">
</td></tr>
</table>

<p style="margin-left:40%;">handles actual data
communication with IM Server. It is done by a set of several
functions named transporters.</p>

<p style="margin-top: 1em">The interface layer and the
transport layer make various communication channels usable
such as X Protocol, TCP/IP, DECnet or STREAM. The following
is a sample implementation for the transporter using the X
connection. Refer to &quot;xtrans&quot; for the transporter
using Socket Transport.</p>

<p style="margin-top: 1em">At the beginning of the X
Transport connection for the XIM transport mechanism, two
different windows must be created either in an Xlib XIM or
in an IM Server, with which the Xlib and the IM Server
exchange the XIM transports by using the ClientMessage
events and Window Properties. In the following, the window
created by the Xlib is referred as the &quot;client
communication window&quot;, and on the other hand, the
window created by the IM Server is referred as the &quot;IMS
communication window&quot;.</p>

<p style="margin-top: 1em"><b>Connection</b></p>

<p style="margin-left:30%; margin-top: 1em">In order to
establish a connection, a communication window is created. A
ClientMessage in the following event&rsquo;s format is sent
to the owner window of XIM_SERVER selection, which the IM
Server has created.</p>

<p style="margin-left:30%; margin-top: 1em">Refer to
&quot;The Input Method Protocol&quot; for the XIM_SERVER
atom.</p>

<p align="center" style="margin-top: 1em">Table D-1; The
ClientMessage sent to the IMS window.</p>

<p><b>Structure Member Contents</b> <br>
int type ClientMessage <br>
u_long serial Set by the X Window System <br>
Bool send_event Set by the X Window System <br>
Display *display The display to which connects <br>
Window window IMS Window ID <br>
Atom message_type XInternAtom(display,
&lsquo;&lsquo;_XIM_XCONNECT&rsquo;&rsquo;, False) <br>
int format 32 <br>
long data.l[0] client communication window ID <br>
long data.l[1] client-major-transport-version (*1) <br>
long data.l[2] client-major-transport-version (*1) <br>
In order to establish the connection (to notify the IM
Server communication window), the IM Server sends a
ClientMessage in the following event&rsquo;s format to the
client communication window.</p>

<p style="margin-top: 1em"><b>14</b></p>

<p style="margin-top: 1em"><b>X Input Method Protocol
libX11 1.3.2</b></p>

<p align="center" style="margin-top: 1em">Table D-2; The
ClientMessage sent by IM Server.</p>

<p><b>Structure Member Contents</b> <br>
int type ClientMessage <br>
u_long serial Set by the X Window System <br>
Bool send_event Set by the X Window System <br>
Display *display The display to which connects <br>
Window window client communication window ID <br>
Atom message_type XInternAtom(display,
&lsquo;&lsquo;_XIM_XCONNECT&rsquo;&rsquo;, False) <br>
int format 32 <br>
long data.l[0] IMS communication window ID <br>
long data.l[1] server-major-transport-version (*1) <br>
long data.l[2] server-minor-transport-version (*1) <br>
long data.l[3] dividing size between ClientMessage and
Property (*2)</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="13%"></td>
<td width="10%">


<p style="margin-top: 1em">(*1)</p></td>
<td width="2%"></td>
<td width="73%">



<p style="margin-top: 1em">major/minor-transport-version</p> </td>
<td width="2%">
</td></tr>
</table>

<p style="margin-left:50%;">The read/write method is
decided by the combination of major/minor-transport-version,
as follows:</p>

<p align="center" style="margin-top: 1em">Table D-3; The
read/write method and the major/minor-transport-version</p>

<p><b>Transport-version read/write <br>
major minor</b> <br>
0 0 only-CM &amp; Property-with-CM <br>
1 only-CM &amp; multi-CM <br>
2 only-CM &amp; multi-CM &amp; Property-with-CM <br>
1 0 PropertyNotify <br>
2 0 only-CM &amp; PropertyNotify <br>
1 only-CM &amp; multi-CM &amp; PropertyNotify</p>

<p style="margin-left:944%;">only-CM : data is sent via a
ClientMessage <br>
multi-CM : data is sent via multiple ClientMessages <br>
Property-with-CM : <br>
data is written in Property, and its Atom is send via
ClientMessage <br>
PropertyNotify : <br>
data is written in Property, and its Atom is send via
PropertyNotify</p>

<p style="margin-left:40%; margin-top: 1em">The method to
decide major/minor-transport-version is as follows:</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="13%"></td>
<td width="20%">


<p style="margin-top: 1em">(1)</p></td>
<td width="5%"></td>
<td width="62%">


<p style="margin-top: 1em">The client sends 0 as
major/minor-transport-version to the IM Server. The client
must support all methods in Table D-3. The client may send
another number as major/minor-transport-version to use other
method than the above in the future.</p></td></tr>
<tr valign="top" align="left">
<td width="13%"></td>
<td width="20%">


<p style="margin-top: 1em">(2)</p></td>
<td width="5%"></td>
<td width="62%">


<p style="margin-top: 1em">The IM Server sends its
major/minor-transport-version number to the client. The
client sends data using the method specified by the IM
Server.</p> </td></tr>
<tr valign="top" align="left">
<td width="13%"></td>
<td width="20%">


<p style="margin-top: 1em">(3)</p></td>
<td width="5%"></td>
<td width="62%">


<p style="margin-top: 1em">If major/minor-transport-version
number is not available, it is regarded as 0.</p></td></tr>
<tr valign="top" align="left">
<td width="13%"></td>
<td width="20%">


<p>(*2)</p></td>
<td width="5%"></td>
<td width="62%">
</td></tr>
</table>

<p style="margin-left:30%;">dividing size between
ClientMessage and Property</p>

<p style="margin-left:50%;">If data is sent via both of
multi-CM and Property, specify the dividing size between
ClientMessage and Property. The data, which is smaller than
this size, is sent via multi-CM (or only-CM), and the data,
which is lager than this size, is sent via Property.</p>

<p style="margin-top: 1em"><b>read/write</b></p>

<p style="margin-left:30%; margin-top: 1em">The data is
transferred via either ClientMessage or Window Property in
the X Window System.</p>

<p style="margin-left:30%; margin-top: 1em"><b>Format for
the data from the Client to the IM Server</b></p>


<p style="margin-left:40%; margin-top: 1em"><b>ClientMessage</b></p>

<p style="margin-left:40%; margin-top: 1em">If data is sent
via ClientMessage event, the format is as follows:</p>

<p align="center" style="margin-top: 1em">Table D-4; The
ClientMessage event&rsquo;s format (first or middle)</p>

<p><b>Structure Member Contents</b> <br>
int type ClientMessage <br>
u_long serial Set by the X Window System <br>
Bool send_event Set by the X Window System <br>
Display *display The display to which connects <br>
Window window IMS communication window ID <br>
Atom message_type XInternAtom(display,
&lsquo;&lsquo;_XIM_MOREDATA&rsquo;&rsquo;, False) <br>
int format 8 <br>
char data.b[20] (read/write DATA : 20 byte)</p>

<p align="center">Table D-5; The ClientMessage
event&rsquo;s format (only or last)</p>

<p><b>Structure Member Contents</b> <br>
int type ClientMessage <br>
u_long serial Set by the X Window System <br>
Bool send_event Set by the X Window System <br>
Display *display The display to which connects <br>
Window window IMS communication window ID <br>
Atom message_type XInternAtom(display,
&lsquo;&lsquo;_XIM_PROTOCOL&rsquo;&rsquo;, False) <br>
int format 8 <br>
char data.b[20] (read/write DATA : MAX 20 byte) (*1)</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="25%"></td>
<td width="10%">


<p>(*1)</p></td>
<td width="3%"></td>
<td width="62%">


<p>If the data is smaller than 20 byte, all data other than
available data must be 0.</p></td></tr>
</table>


<p style="margin-left:40%; margin-top: 1em"><b>Property</b></p>

<p style="margin-left:40%; margin-top: 1em">In the case of
large data, data will be sent via the Window Property for
the efficiency. There are the following two methods to
notify Property, and transport-version is decided which
method is used.</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="25%"></td>
<td width="8%">


<p style="margin-top: 1em">(1)</p></td>
<td width="5%"></td>
<td width="62%">


<p style="margin-top: 1em">The XChangeProperty function is
used to store data in the client communication window, and
Atom of the stored data is notified to the IM Server via
ClientMessage event.</p></td></tr>
<tr valign="top" align="left">
<td width="25%"></td>
<td width="8%">


<p style="margin-top: 1em">(2)</p></td>
<td width="5%"></td>
<td width="62%">


<p style="margin-top: 1em">The XChangeProperty function is
used to store data in the client communication window, and
Atom of the stored data is notified to the IM Server via
PropertyNotify event.</p></td></tr>
</table>

<p style="margin-left:40%; margin-top: 1em">The arguments
of the XChangeProperty are as follows:</p>

<p style="margin-top: 1em"><b>15</b></p>

<p style="margin-top: 1em"><b>X Input Method Protocol
libX11 1.3.2</b></p>

<p align="center" style="margin-top: 1em">Table D-6; The
XChangeProperty event&rsquo;s format</p>

<p><b>Argument Contents</b> <br>
Display *display The display to which connects <br>
Window window IMS communication window ID <br>
Atom property read/write property Atom (*1) <br>
Atom type XA_STRING <br>
int format 8 <br>
int mode PropModeAppend <br>
u_char *data read/write DATA <br>
int nelements length of DATA</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="25%"></td>
<td width="10%">


<p style="margin-top: 1em">(*1)</p></td>
<td width="3%"></td>
<td width="62%">


<p style="margin-top: 1em">The read/write property ATOM
allocates the following strings by <b>XInternAtom</b>.</p></td></tr>
</table>


<p style="margin-left:60%;">&lsquo;&lsquo;_clientXXX&rsquo;&rsquo;</p>

<p style="margin-left:40%; margin-top: 1em">The client
changes the property with the mode of PropModeAppend and the
IM Server will read it with the delete mode i.e. (delete =
True).</p>

<p style="margin-left:40%; margin-top: 1em">If Atom is
notified via ClientMessage event, the format of the
ClientMessage is as follows:</p>

<p align="center" style="margin-top: 1em">Table D-7; The
ClientMessage event&rsquo;s format to send Atom of
property</p>

<p><b>Structure Member Contents</b> <br>
int type ClientMessage <br>
u_long serial Set by the X Window System <br>
Bool send_event Set by the X Window System <br>
Display *display The display to which connects <br>
Window window IMS communication window ID <br>
Atom message_type XInternAtom(display,
&lsquo;&lsquo;_XIM_PROTOCOL&rsquo;&rsquo;, False) <br>
int format 32 <br>
long data.l[0] length of read/write property Atom <br>
long data.l[1] read/write property Atom</p>

<p style="margin-left:30%;"><b>Format for the data from the
IM Server to the Client</b></p>


<p style="margin-left:40%; margin-top: 1em"><b>ClientMessage</b></p>

<p style="margin-left:40%; margin-top: 1em">The format of
the ClientMessage is as follows:</p>

<p align="center" style="margin-top: 1em">Table D-8; The
ClientMessage event&rsquo;s format (first or middle)</p>

<p><b>Structure Member Contents</b> <br>
int type ClientMessage <br>
u_long serial Set by the X Window System <br>
Bool send_event Set by the X Window System <br>
Display *display The display to which connects <br>
Window window client communication window ID <br>
Atom message_type XInternAtom(display,
&lsquo;&lsquo;_XIM_MOREDATA&rsquo;&rsquo;, False) <br>
int format 8 <br>
char data.b[20] (read/write DATA : 20 byte)</p>

<p style="margin-top: 1em"><b>16</b></p>

<p style="margin-top: 1em"><b>X Input Method Protocol
libX11 1.3.2</b></p>

<p align="center" style="margin-top: 1em">Table D-9; The
ClientMessage event&rsquo;s format (only or last)</p>

<p><b>Structure Member Contents</b> <br>
int type ClientMessage <br>
u_long serial Set by the X Window System <br>
Bool send_event Set by the X Window System <br>
Display *display The display to which connects <br>
Window window client communication window ID <br>
Atom message_type XInternAtom(display,
&lsquo;&lsquo;_XIM_PROTOCOL&rsquo;&rsquo;, False) <br>
int format 8 <br>
char data.b[20] (read/write DATA : MAX 20 byte) (*1)</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="25%"></td>
<td width="10%">


<p style="margin-top: 1em">(*1)</p></td>
<td width="3%"></td>
<td width="62%">


<p style="margin-top: 1em">If the data size is smaller than
20 bytes, all data other than available data must be 0.</p></td></tr>
</table>


<p style="margin-left:40%; margin-top: 1em"><b>Property</b></p>

<p style="margin-left:40%; margin-top: 1em">In the case of
large data, data will be sent via the Window Property for
the efficiency. There are the following two methods to
notify Property, and transport-version is decided which
method is used.</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="25%"></td>
<td width="8%">


<p style="margin-top: 1em">(1)</p></td>
<td width="5%"></td>
<td width="62%">


<p style="margin-top: 1em">The XChangeProperty function is
used to store data in the IMS communication window, and Atom
of the property is sent via the ClientMessage event.</p></td></tr>
<tr valign="top" align="left">
<td width="25%"></td>
<td width="8%">


<p style="margin-top: 1em">(2)</p></td>
<td width="5%"></td>
<td width="62%">


<p style="margin-top: 1em">The XChangeProperty function is
used to store data in the IMS communication window, and Atom
of the property is sent via PropertyNotify event.</p></td></tr>
</table>

<p style="margin-left:40%; margin-top: 1em">The arguments
of the XChangeProperty are as follows:</p>

<p align="center" style="margin-top: 1em">Table D-10; The
XChangeProperty event&rsquo;s format</p>

<p><b>Argument Contents</b> <br>
Display *display The display which to connects <br>
Window window client communication window ID <br>
Atom property read/write property Atom (*1) <br>
Atom type XA_STRING <br>
int format 8 <br>
int mode PropModeAppend <br>
u_char *data read/write DATA <br>
int nelements length of DATA</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="25%"></td>
<td width="10%">


<p style="margin-top: 1em">(*1)</p></td>
<td width="3%"></td>
<td width="62%">


<p style="margin-top: 1em">The read/write property ATOM
allocates some strings, which are not allocated by the
client, by <b>XInternAtom</b>.</p></td></tr>
</table>

<p style="margin-left:40%; margin-top: 1em">The IM Server
changes the property with the mode of PropModeAppend and the
client reads it with the delete mode, i.e. (delete =
True).</p>

<p style="margin-left:40%; margin-top: 1em">If Atom is
notified via ClientMessage event, the format of the
ClientMessage is as follows:</p>

<p style="margin-top: 1em"><b>17</b></p>

<p style="margin-top: 1em"><b>X Input Method Protocol
libX11 1.3.2</b></p>

<p align="center" style="margin-top: 1em">Table D-11; The
ClientMessage event&rsquo;s format to send Atom of
property</p>

<p><b>Structure Member Contents</b> <br>
int type ClientMessage <br>
u_long serial Set by the X Window System <br>
Bool send_event Set by the X Window System <br>
Display *display The display to which connects <br>
Window window client communication window ID <br>
Atom message_type XInternAtom(display,
&lsquo;&lsquo;_XIM_PROTOCOL&rsquo;&rsquo;, False) <br>
int format 32 <br>
long data.l[0] length of read/write property ATOM <br>
long data.l[1] read/write property ATOM</p>

<p><b>Closing Connection</b></p>

<p style="margin-left:30%; margin-top: 1em">If the client
disconnect with the IM Server, shutdown function should free
the communication window properties and etc..</p>

<p style="margin-top: 1em"><b>18</b></p>

<p style="margin-top: 1em"><b>X Input Method Protocol
libX11 1.3.2</b></p>

<p align="center" style="margin-top: 1em"><b><big>Table of
Contents</big></b></p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="13%">


<p>1. Introduction</p></td>
<td width="87%">
</td></tr>
</table>

<p>. . . . . . . . . . . . . . . . . . . . <br>
1</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="13%">


<p>1.1. Scope</p></td>
<td width="87%">
</td></tr>
</table>

<p>. . . . . . . . . . . . . . . . . . . . . . . <br>
1</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="13%">


<p>1.2. Background</p></td>
<td width="87%">
</td></tr>
</table>

<p>. . . . . . . . . . . . . . . . . . . . <br>
1</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="13%">


<p>1.3. Input Method Styles</p></td>
<td width="87%">
</td></tr>
</table>

<p>. . . . . . . . . . . . . . . . <br>
1</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="13%">


<p>2. Architecture</p></td>
<td width="87%">
</td></tr>
</table>

<p>. . . . . . . . . . . . . . . . . . . . <br>
1</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="13%">


<p>2.1. Implementation Model</p></td>
<td width="87%">
</td></tr>
</table>

<p>. . . . . . . . . . . . . . . <br>
1</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="13%">


<p>2.2. Structure of IM</p></td>
<td width="87%">
</td></tr>
</table>

<p>. . . . . . . . . . . . . . . . . . <br>
1</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="13%">


<p>2.3. Event Handling Model</p></td>
<td width="87%">
</td></tr>
</table>

<p>. . . . . . . . . . . . . . . <br>
1</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="13%">


<p>2.3.1. BackEnd Method</p></td>
<td width="87%">
</td></tr>
</table>

<p>. . . . . . . . . . . . . . . . . <br>
1</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="13%">


<p>2.3.2. FrontEnd Method</p></td>
<td width="87%">
</td></tr>
</table>

<p>. . . . . . . . . . . . . . . . . <br>
1</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="13%">


<p>2.4. Event Flow Control</p></td>
<td width="87%">
</td></tr>
</table>

<p>. . . . . . . . . . . . . . . . <br>
2</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="13%">


<p>3. Default Preconnection Convention</p></td>
<td width="87%">
</td></tr>
</table>

<p>. . . . . . . . . . <br>
2</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="13%">


<p>4. Protocol</p></td>
<td width="87%">
</td></tr>
</table>

<p>. . . . . . . . . . . . . . . . . . . . . . <br>
2</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="13%">


<p>4.1. Basic Requests Packet Format</p></td>
<td width="87%">
</td></tr>
</table>

<p>. . . . . . . . . . . <br>
2</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="13%">


<p>4.2. Data Types</p></td>
<td width="87%">
</td></tr>
</table>

<p>. . . . . . . . . . . . . . . . . . . . <br>
2</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="13%">


<p>4.3. Error Notification</p></td>
<td width="87%">
</td></tr>
</table>

<p>. . . . . . . . . . . . . . . . <br>
4</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="13%">


<p>4.4. Connection Establishment</p></td>
<td width="87%">
</td></tr>
</table>

<p>. . . . . . . . . . . . . <br>
4</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="13%">


<p>4.5. Event Flow Control</p></td>
<td width="87%">
</td></tr>
</table>

<p>. . . . . . . . . . . . . . . . <br>
4</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="13%">


<p>4.6. Encoding Negotiation</p></td>
<td width="87%">
</td></tr>
</table>

<p>. . . . . . . . . . . . . . . <br>
4</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="13%">


<p>4.7. Query the supported extension protocol list</p></td>
<td width="87%">
</td></tr>
</table>

<p>. . . . <br>
4</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="13%">


<p>4.8. Setting IM Values</p></td>
<td width="87%">
</td></tr>
</table>

<p>. . . . . . . . . . . . . . . . . <br>
4</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="13%">


<p>4.9. getting IM Values</p></td>
<td width="87%">
</td></tr>
</table>

<p>. . . . . . . . . . . . . . . . . <br>
4</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="13%">


<p>4.10. Creating an IC</p></td>
<td width="87%">
</td></tr>
</table>

<p>. . . . . . . . . . . . . . . . . . <br>
4</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="13%">


<p>4.11. Destroying the IC</p></td>
<td width="87%">
</td></tr>
</table>

<p>. . . . . . . . . . . . . . . . <br>
4</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="13%">


<p>4.12. Setting IC Values</p></td>
<td width="87%">
</td></tr>
</table>

<p>. . . . . . . . . . . . . . . . <br>
4</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="13%">


<p>4.13. Getting IC Values</p></td>
<td width="87%">
</td></tr>
</table>

<p>. . . . . . . . . . . . . . . . <br>
4</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="13%">


<p>4.14. Setting IC Focus</p></td>
<td width="87%">
</td></tr>
</table>

<p>. . . . . . . . . . . . . . . . . <br>
4</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="13%">


<p>4.15. Unsetting IC Focus</p></td>
<td width="87%">
</td></tr>
</table>

<p>. . . . . . . . . . . . . . . . <br>
4</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="13%">


<p>4.16. Filtering Events</p></td>
<td width="87%">
</td></tr>
</table>

<p>. . . . . . . . . . . . . . . . . <br>
4</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="13%">


<p>4.17. Synchronizing with the IM Server</p></td>
<td width="87%">
</td></tr>
</table>

<p>. . . . . . . . . <br>
5</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="13%">


<p>4.18. Sending a committed string</p></td>
<td width="87%">
</td></tr>
</table>

<p>. . . . . . . . . . . . <br>
5</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="13%">


<p>4.19. Reset IC</p></td>
<td width="87%">
</td></tr>
</table>

<p>. . . . . . . . . . . . . . . . . . . . . <br>
5</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="13%">


<p>4.20. Callbacks</p></td>
<td width="87%">
</td></tr>
</table>

<p>. . . . . . . . . . . . . . . . . . . . <br>
5</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="13%">


<p>4.20.1. Negotiating geometry</p></td>
<td width="87%">
</td></tr>
</table>

<p>. . . . . . . . . . . . . . <br>
5</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="13%">


<p>4.20.2. Converting a string</p></td>
<td width="87%">
</td></tr>
</table>

<p>. . . . . . . . . . . . . . <br>
5</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="13%">


<p>4.20.3. Preedit Callbacks</p></td>
<td width="87%">
</td></tr>
</table>

<p>. . . . . . . . . . . . . . . <br>
5</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="13%">


<p>4.20.4. Preedit state notify</p></td>
<td width="87%">
</td></tr>
</table>

<p>. . . . . . . . . . . . . . <br>
5</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="13%">


<p>4.20.5. Status Callbacks</p></td>
<td width="87%">
</td></tr>
</table>

<p>. . . . . . . . . . . . . . . . <br>
5</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="13%">


<p>5. Acknowledgements</p></td>
<td width="87%">
</td></tr>
</table>

<p>. . . . . . . . . . . . . . . . . . <br>
6</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="13%">


<p>6. References</p></td>
<td width="87%">
</td></tr>
</table>

<p>. . . . . . . . . . . . . . . . . . . . . <br>
6</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="13%">


<p>Appendix A &minus; Common Extensions</p></td>
<td width="87%">
</td></tr>
</table>

<p>. . . . . . . . . . . . . <br>
7</p>

<p style="margin-top: 1em">Appendix B &minus; The list of
transport specific IM Serv-</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="13%">


<p>er names registered</p></td>
<td width="87%">
</td></tr>
</table>

<p>. . . . . . . . . . . . . . . . . . <br>
9</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="13%">


<p>Appendix C &minus; Protocol number</p></td>
<td width="87%">
</td></tr>
</table>

<p>. . . . . . . . . . . . . . <br>
10</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="13%">


<p>Appendix D &minus; Implementation Tips</p></td>
<td width="87%">
</td></tr>
</table>

<p>. . . . . . . . . . . . <br>
 11</p>
<hr>
</body>
</html>
